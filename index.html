<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sistema de Gesti√≥n de Turnos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.5} }
    .animate-pulse { animation: pulse 2s cubic-bezier(.4,0,.6,1) infinite; }
    @media print { .no-print{display:none!important} body{background:#fff} }
  </style>
</head>

<body class="bg-gray-50">
  <div id="app"></div>

  <!-- Firebase + App -->
  <script type="module">
    /* =====================  Firebase SDK (mismas versiones)  ===================== */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    /* =====================  Config NUEVO del proyecto  ===================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBTM4YLyNUxNCg8SoTrTwqHd-_r386PSPE",
      authDomain: "turnos-caba-cordoba.firebaseapp.com",
      projectId: "turnos-caba-cordoba",
      storageBucket: "turnos-caba-cordoba.appspot.com",   // <- importante .appspot.com
      messagingSenderId: "80133083327",
      appId: "1:80133083327:web:6690bc17e1385ab55de3ca"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getFirestore(appFB);

    /* =====================  Estado / Config de dominio  ===================== */
    let datos = {
      caba6x3: { gabriel: {}, nicolas: {}, sergio: {} },
      caba5x1: {},
      cabaCorreos: {},
      cordobaHoldeos: {},
      licencias: {}
    };

    let vistaActual = 'dashboard';
    let cargando = true;

    const equipoCaba = {
      '5x1': [
        { id: 'lottero', nombre: 'Lottero, Lucas', turno: 'manana' },
        { id: 'lopez', nombre: 'L√≥pez, Deborah', turno: 'manana', excluirCorreos: true },
        { id: 'capdet', nombre: 'Capdet, Gustavo', turno: 'manana' },
        { id: 'torales', nombre: 'Torales, Andr√©s', turno: 'manana' },
        { id: 'fernandez', nombre: 'Fern√°ndez, Nicol√°s', turno: 'tarde' }
      ],
      '6x3': [
        { id: 'gabriel', nombre: 'Palazzini, Gabriel', turno: 'manana' },
        { id: 'meoniz', nombre: 'Meoniz, Nicol√°s', turno: 'tarde' },
        { id: 'sergio', nombre: 'Palacios, Sergio', turno: 'manana' }
      ]
    };

    const rotacionSabadosCaba = ['lopez','capdet','torales','fernandez','lottero'];

    const meses = [
      { key: '2025-10', nombre: 'Octubre 2025', dias: 31, inicioSemana: 3 },
      { key: '2025-11', nombre: 'Noviembre 2025', dias: 30, inicioSemana: 6 },
      { key: '2025-12', nombre: 'Diciembre 2025', dias: 31, inicioSemana: 1 }
    ];

    const feriados = {
      '2025-10': [12], '2025-11': [20], '2025-12': [8, 25]
    };

    /* =====================  Helpers  ===================== */
    function getNumeroSemana(fecha) {
      const d = new Date(Date.UTC(fecha.getFullYear(), fecha.getMonth(), fecha.getDate()));
      const dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
      return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    }

    function calcularSabadoCaba(fecha) {
      const referencia = new Date('2025-10-04'); // s√°bado referencia: Deborah
      const diffSemanas = Math.floor((fecha - referencia) / (7 * 24 * 60 * 60 * 1000));
      const idx = ((diffSemanas % 5) + 5) % 5;
      return rotacionSabadosCaba[idx];
    }

    /* =====================  UI (muy simple para probar)  ===================== */
    function header() {
      return `
        <div class="bg-white shadow-md no-print">
          <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between py-4">
              <h1 class="text-2xl font-bold text-gray-800">Sistema de Gesti√≥n de Turnos</h1>
              <div class="flex items-center gap-2 bg-green-100 px-3 py-1 rounded-full">
                <span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span>
                <span class="text-sm font-semibold text-green-700">En vivo</span>
              </div>
            </div>
            <nav class="flex gap-2 pb-2 overflow-x-auto">
              ${tab('dashboard','üè† Dashboard')}
              ${tab('caba6x3','CABA 6x3')}
              ${tab('caba5x1','CABA 5+1')}
              ${tab('cabaCorreos','üìß Correos')}
              ${tab('cordoba','C√≥rdoba')}
            </nav>
          </div>
        </div>`;
    }
    function tab(id, label){
      const active = vistaActual===id ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300';
      return `<button data-vista="${id}" class="px-4 py-2 rounded-t-lg font-semibold ${active}">${label}</button>`;
    }

    function viewDashboard(){
      const hoy = new Date();
      const semana = getNumeroSemana(hoy);
      const proximoSab = (() => {
        const d = new Date(hoy);
        const day = d.getDay(); // 0 dom ... 6 sab
        const add = (6 - day + 7) % 7 || 7;
        d.setDate(d.getDate() + add);
        return d;
      })();
      const quienSabadoCaba = calcularSabadoCaba(proximoSab);
      const nombreSabado = equipoCaba['5x1'].find(p=>p.id===quienSabadoCaba)?.nombre || '‚Äî';

      return `
      <div class="max-w-7xl mx-auto p-6">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Dashboard - Semana ${semana}</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
            <h3 class="text-xl font-bold mb-2">üìß Correos CABA - Esta Semana</h3>
            <p class="opacity-90 text-sm mb-2">Ejemplo fijo (luego vendr√° del algoritmo)</p>
            <div class="space-y-3">
              <div class="bg-white/20 rounded p-3">
                <div class="text-sm opacity-90">üåÖ Ma√±ana (8:00)</div>
                <div class="text-lg font-bold">Gabriel Palazzini</div>
              </div>
              <div class="bg-white/20 rounded p-3">
                <div class="text-sm opacity-90">üåÜ Tarde (12:20)</div>
                <div class="text-lg font-bold">Nicol√°s Meoniz</div>
              </div>
            </div>
          </div>

          <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-lg shadow-lg p-6 text-white">
            <h3 class="text-xl font-bold mb-2">üè¢ Holdeo C√≥rdoba - Esta Semana</h3>
            <div class="bg-white/20 rounded p-3">
              <div class="text-sm opacity-90">Lunes a Domingo</div>
              <div class="text-lg font-bold">Asignaci√≥n semanal (placeholder)</div>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6">
          <h3 class="text-xl font-bold mb-4">üìä Resumen</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="border-l-4 border-blue-500 pl-4">
              <div class="text-sm text-gray-600">Equipo CABA</div>
              <div class="text-2xl font-bold">8 personas</div>
              <div class="text-xs text-gray-500">5 en 5+1, 3 en 6x3</div>
            </div>
            <div class="border-l-4 border-purple-500 pl-4">
              <div class="text-sm text-gray-600">Equipo C√≥rdoba</div>
              <div class="text-2xl font-bold">10 personas</div>
              <div class="text-xs text-gray-500">Todos 5+1</div>
            </div>
            <div class="border-l-4 border-green-500 pl-4">
              <div class="text-sm text-gray-600">Pr√≥ximo S√°bado</div>
              <div class="text-md font-semibold">${proximoSab.toLocaleDateString()}</div>
              <div class="text-xs text-gray-500">CABA: ${nombreSabado}</div>
            </div>
          </div>
        </div>
      </div>`;
    }

    function viewPlaceholder(titulo){
      return `
        <div class="max-w-7xl mx-auto p-6">
          <h2 class="text-2xl font-bold mb-4">${titulo}</h2>
          <p class="text-gray-600">M√≥dulo en construcci√≥n‚Ä¶</p>
        </div>`;
    }

    function footer(){
      return `<footer class="mt-8 text-center text-xs text-gray-400 pb-4">Creado por Gabriel Palazzini</footer>`;
    }

    function attachNavHandlers(){
      document.querySelectorAll('button[data-vista]').forEach(btn=>{
        btn.onclick = () => { vistaActual = btn.dataset.vista; renderApp(); };
      });
    }

    function renderApp(){
      const app = document.getElementById('app');

      if (cargando) {
        app.innerHTML = `
          <div class="flex items-center justify-center min-h-screen">
            <div class="text-center">
              <div class="text-4xl mb-4">üîÑ</div>
              <p class="text-xl font-semibold">Conectando‚Ä¶</p>
            </div>
          </div>`;
        return;
      }

      let contenido = '';
      if (vistaActual === 'dashboard') contenido = viewDashboard();
      else if (vistaActual === 'caba6x3') contenido = viewPlaceholder('CABA - Rotaci√≥n 6x3');
      else if (vistaActual === 'caba5x1') contenido = viewPlaceholder('CABA - S√°bados 5+1');
      else if (vistaActual === 'cabaCorreos') contenido = viewPlaceholder('Gesti√≥n de Correos CABA');
      else if (vistaActual === 'cordoba') contenido = viewPlaceholder('C√≥rdoba - Holdeos');

      app.innerHTML = header() + contenido + footer();
      attachNavHandlers();
    }

    /* =====================  Seed autom√°tico + live snapshot  ===================== */
    (async () => {
      const ref = doc(db, "turnos", "sistema");

      // crea el doc si no existe (con reglas DEV abiertas)
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, datos, { merge: true });
        console.log("Seed creado: turnos/sistema");
      }

      onSnapshot(ref, (s) => {
        if (s.exists()) datos = s.data();
        cargando = false;
        renderApp();
      });

      renderApp(); // pantalla "Conectando‚Ä¶" mientras llega el primer snapshot
    })();
  </script>
</body>
</html>
