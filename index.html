<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gesti√≥n de Turnos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    
    * {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf1 100%);
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
    }
    
    .glass-button {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.8);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .glass-button:hover {
      background: rgba(255, 255, 255, 1);
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
    }
    
    .nav-tab {
      transition: all 0.3s ease;
      position: relative;
    }
    
    .nav-tab::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: currentColor;
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .nav-tab.active::after {
      transform: scaleX(1);
    }
    
    .status-badge {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .smooth-shadow {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04), 0 4px 16px rgba(0, 0, 0, 0.06);
    }
    
    .hover-lift {
      transition: all 0.3s ease;
    }
    
    .hover-lift:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    }
    
    .scroll-smooth {
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.2) transparent;
    }
    
    .scroll-smooth::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    .scroll-smooth::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .scroll-smooth::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }
    
    .scroll-smooth::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.3);
    }
    
    input, select, button {
      transition: all 0.2s ease;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #0078d4;
      box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
    }
    
    .chat-message {
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBTM4YLyNUxNCg8SoTrTwqHd-_r386PSPE",
      authDomain: "turnos-caba-cordoba.firebaseapp.com",
      projectId: "turnos-caba-cordoba",
      storageBucket: "turnos-caba-cordoba.firebasestorage.app",
      messagingSenderId: "801338083327",
      appId: "1:801338083327:web:67ea89fee2ef6e875de3ca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== ESTADO GLOBAL =====
    let licencias = {};
    let tareas = { correos: {}, holdeos: {} };
    let vistaActual = 'dashboard';
    let mesSeleccionado = '2025-10';
    let mostrarFormLicencia = false;
    let mostrarFormTareas = false;
    let mostrarChat = false;
    let mensaje = '';
    let cargando = true;
    let chatHistory = [];
    let procesandoChat = false;

    // ===== CONFIGURACI√ìN =====
    const MESES_DISPONIBLES = [
      { key: '2025-10', nombre: 'Octubre 2025', dias: 31 },
      { key: '2025-11', nombre: 'Noviembre 2025', dias: 30 },
      { key: '2025-12', nombre: 'Diciembre 2025', dias: 31 },
      { key: '2026-01', nombre: 'Enero 2026', dias: 31 },
      { key: '2026-02', nombre: 'Febrero 2026', dias: 28 },
      { key: '2026-03', nombre: 'Marzo 2026', dias: 31 },
      { key: '2026-04', nombre: 'Abril 2026', dias: 30 },
      { key: '2026-05', nombre: 'Mayo 2026', dias: 31 },
      { key: '2026-06', nombre: 'Junio 2026', dias: 30 }
    ];

    const FERIADOS = {
      '2025-10': [12],
      '2025-11': [20],
      '2025-12': [8, 25],
      '2026-01': [1],
      '2026-02': [16, 17],
      '2026-03': [24],
      '2026-04': [2, 3],
      '2026-05': [1, 25],
      '2026-06': [15, 20]
    };

    const NOMBRES_FERIADOS = {
      '2025-10-12': 'Respeto a la Diversidad Cultural',
      '2025-11-20': 'D√≠a de la Soberan√≠a Nacional',
      '2025-12-08': 'Inmaculada Concepci√≥n',
      '2025-12-25': 'Navidad',
      '2026-01-01': 'A√±o Nuevo',
      '2026-02-16': 'Carnaval',
      '2026-02-17': 'Carnaval',
      '2026-03-24': 'Memoria por la Verdad y la Justicia',
      '2026-04-02': 'D√≠a del Veterano y Malvinas',
      '2026-04-03': 'Viernes Santo',
      '2026-05-01': 'D√≠a del Trabajador',
      '2026-05-25': 'Revoluci√≥n de Mayo',
      '2026-06-15': 'Gral. Mart√≠n Miguel de G√ºemes',
      '2026-06-20': 'Gral. Manuel Belgrano'
    };

    const EQUIPOS = {
      caba_5x1: [
        { id: 'lottero', nombre: 'Lottero, Lucas', turno: 'ma√±ana' },
        { id: 'lopez', nombre: 'L√≥pez, Deborah', turno: 'ma√±ana', excluirCorreos: true },
        { id: 'capdet', nombre: 'Capdet, Gustavo', turno: 'ma√±ana' },
        { id: 'torales', nombre: 'Torales, Andr√©s', turno: 'ma√±ana' },
        { id: 'fernandez', nombre: 'Fern√°ndez, Nicol√°s', turno: 'tarde' }
      ],
      caba_6x3: [
        { id: 'gabriel', nombre: 'Palazzini, Gabriel', turno: 'ma√±ana' },
        { id: 'meoniz', nombre: 'Meoniz, Nicol√°s', turno: 'tarde' },
        { id: 'sergio', nombre: 'Palacios, Sergio', turno: 'ma√±ana' }
      ],
      cordoba: [
        { id: 'guzman', nombre: 'Guzm√°n, Luis' },
        { id: 'luna', nombre: 'Luna, Mart√≠n' },
        { id: 'diaz_s', nombre: 'D√≠az, Sebasti√°n' },
        { id: 'poles', nombre: 'Poles, Marina' },
        { id: 'diaz_j', nombre: 'D√≠az, Jorge' },
        { id: 'allende', nombre: 'Allende, Alejandro' },
        { id: 'pereyra', nombre: 'Pereyra, Jos√©' },
        { id: 'spicogna', nombre: 'Spicogna, Ariel' },
        { id: 'garrafa', nombre: 'Garrafa, Nico' },
        { id: 'baldamus', nombre: 'Baldamus, Gabriela' }
      ]
    };

    const TODOS_EMPLEADOS = [...EQUIPOS.caba_5x1, ...EQUIPOS.caba_6x3, ...EQUIPOS.cordoba];

    const ROTACION_CABA_SABADOS = ['lopez', 'capdet', 'torales', 'fernandez', 'lottero'];
    const ROTACION_CORDOBA_SABADOS = [
      ['luna', 'spicogna'],
      ['diaz_s', 'diaz_j', 'baldamus', 'allende'],
      ['guzman', 'pereyra'],
      ['poles']
    ];

    const INICIO_6X3 = {
      gabriel: new Date(2025, 9, 11),
      meoniz: new Date(2025, 9, 11),
      sergio: new Date(2025, 9, 6)
    };

    const EQUIPO_CORREOS_MANANA = ['lottero', 'capdet', 'torales', 'gabriel', 'sergio'];
    const EQUIPO_CORREOS_TARDE = ['fernandez', 'meoniz'];
    const EQUIPO_HOLDEOS = ['guzman', 'luna', 'diaz_s', 'poles', 'diaz_j', 'allende', 'pereyra', 'spicogna', 'garrafa', 'baldamus'];

    // ===== FIREBASE SYNC =====
    onSnapshot(doc(db, 'turnos', 'datos'), (docSnap) => {
      try {
        if (docSnap.exists()) {
          const data = docSnap.data();
          licencias = data.licencias || {};
          tareas = data.tareas || { correos: {}, holdeos: {} };
          console.log('‚úÖ Datos cargados desde Firebase');
        } else {
          console.log('üìù Documento no existe, creando inicial...');
          licencias = {};
          tareas = { correos: {}, holdeos: {} };
          guardarFirebase();
        }
        cargando = false;
        renderApp();
      } catch (error) {
        console.error('‚ùå Error procesando datos:', error);
        cargando = false;
        mensaje = '‚ùå Error al cargar datos';
        renderApp();
      }
    }, (error) => {
      console.error('‚ùå Error Firebase:', error);
      cargando = false;
      mensaje = '‚ùå Error de conexi√≥n con Firebase';
      renderApp();
    });

    async function guardarFirebase() {
      try {
        const datos = {
          licencias,
          tareas,
          ultimaActualizacion: new Date().toISOString()
        };
        await setDoc(doc(db, 'turnos', 'datos'), datos);
        console.log('‚úÖ Guardado en Firebase');
        mostrarMensaje('‚úÖ Guardado');
        return true;
      } catch (error) {
        console.error('‚ùå Error al guardar:', error);
        mostrarMensaje('‚ùå Error al guardar');
        return false;
      }
    }

    function mostrarMensaje(msg) {
      mensaje = msg;
      renderApp();
      setTimeout(() => { mensaje = ''; renderApp(); }, 3000);
    }

    // ===== UTILIDADES =====
    function getNombreDia(dia) {
      const [a√±o, mes] = mesSeleccionado.split('-');
      const fecha = new Date(a√±o, mes - 1, dia);
      return ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'][fecha.getDay()];
    }

    function esSabado(dia) { return getNombreDia(dia) === 'S√°b'; }
    function esDomingo(dia) { return getNombreDia(dia) === 'Dom'; }
    function esFeriado(dia) { return (FERIADOS[mesSeleccionado] || []).includes(dia); }

    function getDiasEnMes() {
      const mesInfo = MESES_DISPONIBLES.find(m => m.key === mesSeleccionado);
      return mesInfo ? mesInfo.dias : 31;
    }

    function getNombreMes() {
      const mesInfo = MESES_DISPONIBLES.find(m => m.key === mesSeleccionado);
      return mesInfo ? mesInfo.nombre : mesSeleccionado;
    }

    function getFechaKey(dia) {
      const [a√±o, mes] = mesSeleccionado.split('-');
      return `${a√±o}-${mes}-${String(dia).padStart(2, '0')}`;
    }

    function getNombreFeriado(dia) {
      const fechaKey = getFechaKey(dia);
      return NOMBRES_FERIADOS[fechaKey] || 'Feriado Nacional';
    }

    function getSemanaISO(fecha) {
      const d = new Date(fecha);
      const dayNum = d.getDay() || 7;
      d.setDate(d.getDate() + 4 - dayNum);
      const yearStart = new Date(d.getFullYear(), 0, 1);
      const weekNum = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return `${d.getFullYear()}-W${String(weekNum).padStart(2, '0')}`;
    }

    function getSemanaActual() {
      return getSemanaISO(new Date());
    }

    function getFechaInicioSemana(semanaISO) {
      const [a√±o, semana] = semanaISO.split('-W');
      const fecha = new Date(a√±o, 0, 1 + (semana - 1) * 7);
      const dia = fecha.getDay();
      const diff = fecha.getDate() - dia + (dia === 0 ? -6 : 1);
      return new Date(fecha.setDate(diff));
    }

    function getSemanasDelMes(mes) {
      const [a√±o, mesNum] = mes.split('-');
      const diasMes = MESES_DISPONIBLES.find(m => m.key === mes)?.dias || 31;
      const semanas = new Set();
      
      for (let dia = 1; dia <= diasMes; dia++) {
        const fecha = new Date(a√±o, mesNum - 1, dia);
        semanas.add(getSemanaISO(fecha));
      }
      
      return Array.from(semanas).sort();
    }

    // ===== ALGORITMO DE TRABAJO (REVISADO) =====
    
    // Equipo 5+1: Trabaja lunes a viernes + s√°bados por rotaci√≥n
    // NO trabaja domingos NI feriados
    function trabaja5x1(personaId, dia) {
      if (esFeriado(dia)) return false;  // NO trabaja feriados
      if (esDomingo(dia)) return false;  // NO trabaja domingos
      if (!esSabado(dia)) return true;   // Trabaja lunes a viernes
      
      // Para s√°bados, verifica rotaci√≥n
      const primerSabado = new Date(2025, 9, 4);
      const [a√±o, mes] = mesSeleccionado.split('-');
      const fechaActual = new Date(a√±o, mes - 1, dia);
      const difDias = Math.floor((fechaActual - primerSabado) / (24 * 60 * 60 * 1000));
      const semanas = Math.floor(difDias / 7);
      const indice = semanas % ROTACION_CABA_SABADOS.length;
      
      return ROTACION_CABA_SABADOS[indice] === personaId;
    }

    // Equipo C√≥rdoba: Similar a 5+1
    function trabajaCordoba(personaId, dia) {
      if (esFeriado(dia)) return false;
      if (esDomingo(dia)) return false;
      if (!esSabado(dia)) return true;
      
      const primerSabado = new Date(2025, 9, 4);
      const [a√±o, mes] = mesSeleccionado.split('-');
      const fechaActual = new Date(a√±o, mes - 1, dia);
      const difDias = Math.floor((fechaActual - primerSabado) / (24 * 60 * 60 * 1000));
      const semanas = Math.floor(difDias / 7);
      const indice = semanas % ROTACION_CORDOBA_SABADOS.length;
      
      return ROTACION_CORDOBA_SABADOS[indice].includes(personaId);
    }

    // Equipo 6x3: Trabaja 6 d√≠as, 3 de franco (incluyendo s√°bados, domingos Y feriados)
    function trabaja6x3(personaId, dia) {
      const [a√±o, mes] = mesSeleccionado.split('-');
      const fechaActual = new Date(a√±o, mes - 1, dia);
      const inicioPersona = INICIO_6X3[personaId];
      
      if (!inicioPersona) return true;
      
      const difDias = Math.floor((fechaActual - inicioPersona) / (24 * 60 * 60 * 1000));
      const posicionEnCiclo = ((difDias % 9) + 9) % 9;
      
      return posicionEnCiclo >= 3;  // Trabaja si est√° en los d√≠as 3-8 del ciclo
    }

    function getTipoTrabajo(personaId) {
      if (EQUIPOS.caba_6x3.find(p => p.id === personaId)) return '6x3';
      if (EQUIPOS.cordoba.find(p => p.id === personaId)) return 'cordoba';
      return '5x1';
    }

    function trabajaDia(personaId, dia) {
      const tipo = getTipoTrabajo(personaId);
      if (tipo === '6x3') return trabaja6x3(personaId, dia);
      if (tipo === 'cordoba') return trabajaCordoba(personaId, dia);
      return trabaja5x1(personaId, dia);
    }

    // ===== C√ÅLCULO DE D√çAS TRABAJADOS =====
    function calcularDiasTrabajados() {
      const contador = {};
      
      [...EQUIPO_CORREOS_MANANA, ...EQUIPO_CORREOS_TARDE].forEach(id => {
        contador[id] = 0;
      });

      MESES_DISPONIBLES.forEach(mes => {
        const semanas = getSemanasDelMes(mes.key);
        
        semanas.forEach(semana => {
          const correo = tareas.correos[semana];
          if (correo) {
            if (correo.ma√±ana) {
              const fechaInicio = getFechaInicioSemana(semana);
              let diasHabiles = 0;
              
              for (let i = 0; i < 7; i++) {
                const fecha = new Date(fechaInicio);
                fecha.setDate(fecha.getDate() + i);
                const dia = fecha.getDay();
                
                if (dia >= 1 && dia <= 5) {
                  const fechaKey = fecha.toISOString().split('T')[0];
                  const tieneLicencia = licencias[correo.ma√±ana]?.[fechaKey];
                  
                  if (!tieneLicencia) {
                    diasHabiles++;
                  }
                }
              }
              
              contador[correo.ma√±ana] = (contador[correo.ma√±ana] || 0) + diasHabiles;
            }
            
            if (correo.tarde) {
              const fechaInicio = getFechaInicioSemana(semana);
              let diasHabiles = 0;
              
              for (let i = 0; i < 7; i++) {
                const fecha = new Date(fechaInicio);
                fecha.setDate(fecha.getDate() + i);
                const dia = fecha.getDay();
                
                if (dia >= 1 && dia <= 5) {
                  const fechaKey = fecha.toISOString().split('T')[0];
                  const tieneLicencia = licencias[correo.tarde]?.[fechaKey];
                  
                  if (!tieneLicencia) {
                    diasHabiles++;
                  }
                }
              }
              
              contador[correo.tarde] = (contador[correo.tarde] || 0) + diasHabiles;
            }
          }
        });
      });

      return contador;
    }

    // ===== PROCESAMIENTO DE CHAT SIN IA (100% GRATUITO) =====
    
    function buscarEmpleado(texto) {
      texto = texto.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      
      for (const empleado of TODOS_EMPLEADOS) {
        const nombreNorm = empleado.nombre.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        const palabras = nombreNorm.split(/[\s,]+/);
        
        let coincidencias = 0;
        for (const palabra of palabras) {
          if (palabra.length > 2 && texto.includes(palabra)) {
            coincidencias++;
          }
        }
        
        if (coincidencias >= 1) {
          return empleado;
        }
      }
      return null;
    }

    function extraerTipoLicencia(texto) {
      texto = texto.toLowerCase();
      
      if (texto.match(/vacacion|feriado|descanso/)) return 'vacaciones';
      if (texto.match(/enferm|medic|doctor|salud|hospital/)) return 'enfermedad';
      if (texto.match(/examen|estudio|universidad|facultad/)) return 'examen';
      
      return null;
    }

    function extraerFechas(texto) {
      texto = texto.toLowerCase()
        .replace(/enero/g, '01').replace(/febrero/g, '02').replace(/marzo/g, '03')
        .replace(/abril/g, '04').replace(/mayo/g, '05').replace(/junio/g, '06')
        .replace(/julio/g, '07').replace(/agosto/g, '08').replace(/septiembre/g, '09')
        .replace(/octubre/g, '10').replace(/noviembre/g, '11').replace(/diciembre/g, '12');
      
      const fechas = [];
      
      const patron1 = /(\d{1,2})[\/-](\d{1,2})[\/-](\d{4})/g;
      let match;
      while ((match = patron1.exec(texto)) !== null) {
        const dia = match[1].padStart(2, '0');
        const mes = match[2].padStart(2, '0');
        const a√±o = match[3];
        fechas.push(`${a√±o}-${mes}-${dia}`);
      }
      
      const patron2 = /(\d{1,2})\s*(?:de)?\s*(\d{1,2})/g;
      while ((match = patron2.exec(texto)) !== null) {
        const dia = match[1].padStart(2, '0');
        const mes = match[2].padStart(2, '0');
        const a√±o = new Date().getFullYear();
        
        if (parseInt(mes) >= 1 && parseInt(mes) <= 12 && parseInt(dia) >= 1 && parseInt(dia) <= 31) {
          fechas.push(`${a√±o}-${mes}-${dia}`);
        }
      }
      
      const patron3 = /(\d{4})-(\d{1,2})-(\d{1,2})/g;
      while ((match = patron3.exec(texto)) !== null) {
        const a√±o = match[1];
        const mes = match[2].padStart(2, '0');
        const dia = match[3].padStart(2, '0');
        fechas.push(`${a√±o}-${mes}-${dia}`);
      }
      
      return fechas.length > 0 ? fechas : null;
    }

    function extraerSemana(texto) {
      texto = texto.toLowerCase();
      
      // Semana actual
      if (texto.match(/esta semana|semana actual|ahora/)) {
        return getSemanaActual();
      }
      
      // Pr√≥xima semana
      if (texto.match(/proxima semana|siguiente semana|que viene/)) {
        const hoy = new Date();
        const proximaSemana = new Date(hoy.getTime() + 7 * 24 * 60 * 60 * 1000);
        return getSemanaISO(proximaSemana);
      }
      
      // N√∫mero de semana espec√≠fico
      const matchSemana = texto.match(/semana\s*(\d+)/);
      if (matchSemana) {
        const numSemana = matchSemana[1].padStart(2, '0');
        const a√±o = new Date().getFullYear();
        return `${a√±o}-W${numSemana}`;
      }
      
      // Fecha espec√≠fica dentro del comando
      const fechas = extraerFechas(texto);
      if (fechas && fechas.length > 0) {
        return getSemanaISO(new Date(fechas[0]));
      }
      
      return null;
    }

    function detectarTipoComando(texto) {
      texto = texto.toLowerCase();
      
      // Consultas
      if (texto.match(/quien|quienes|mostrar|ver|consultar|listar/)) {
        if (texto.match(/correo|mail|email/)) return 'consulta_correos';
        if (texto.match(/holdeo/)) return 'consulta_holdeo';
        if (texto.match(/licencia|vacacion|franco/)) return 'consulta_licencias';
        if (texto.match(/trabaj/)) return 'consulta_trabajando';
        return 'consulta_general';
      }
      
      // Asignaciones
      if (texto.match(/asignar|poner|agregar|cambiar/) || texto.match(/correo|mail|holdeo/)) {
        if (texto.match(/correo|mail|email/)) return 'asignar_correo';
        if (texto.match(/holdeo/)) return 'asignar_holdeo';
      }
      
      // Licencias (por defecto si tiene fechas)
      if (extraerFechas(texto)) {
        return 'agregar_licencia';
      }
      
      return 'desconocido';
    }

    async function procesarConsulta(tipo, comando) {
      const hoy = new Date();
      const diaHoy = hoy.getDate();
      const mesHoy = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
      const semanaActual = getSemanaActual();

      if (tipo === 'consulta_correos') {
        const semana = extraerSemana(comando) || semanaActual;
        const correo = tareas.correos[semana];
        
        if (!correo) {
          return `üìß No hay asignaciones de correos para la semana ${semana.split('-W')[1]}`;
        }
        
        const ma√±ana = correo.ma√±ana ? TODOS_EMPLEADOS.find(p => p.id === correo.ma√±ana)?.nombre : 'Sin asignar';
        const tarde = correo.tarde ? TODOS_EMPLEADOS.find(p => p.id === correo.tarde)?.nombre : 'Sin asignar';
        
        return `üìß Correos - Semana ${semana.split('-W')[1]}\n\nüåÖ Ma√±ana: ${ma√±ana}\nüåÜ Tarde: ${tarde}`;
      }

      if (tipo === 'consulta_holdeo') {
        const semana = extraerSemana(comando) || semanaActual;
        const holdeo = tareas.holdeos[semana];
        
        if (!holdeo) {
          return `üéØ No hay asignaci√≥n de holdeo para la semana ${semana.split('-W')[1]}`;
        }
        
        const nombre = TODOS_EMPLEADOS.find(p => p.id === holdeo)?.nombre || 'Sin asignar';
        return `üéØ Holdeo - Semana ${semana.split('-W')[1]}\n\n${nombre}`;
      }

      if (tipo === 'consulta_licencias') {
        const fechaKey = `${mesHoy}-${String(diaHoy).padStart(2, '0')}`;
        const licenciasHoy = [];
        
        for (const [personaId, fechas] of Object.entries(licencias)) {
          if (fechas[fechaKey]) {
            const persona = TODOS_EMPLEADOS.find(p => p.id === personaId);
            if (persona) {
              const tipoEmoji = fechas[fechaKey] === 'vacaciones' ? 'üèñÔ∏è' : 
                               fechas[fechaKey] === 'enfermedad' ? 'üè•' : 'üìö';
              licenciasHoy.push(`${tipoEmoji} ${persona.nombre}`);
            }
          }
        }
        
        if (licenciasHoy.length === 0) {
          return `‚úÖ No hay licencias hoy (${hoy.toLocaleDateString('es-AR')})`;
        }
        
        return `üìã Licencias hoy (${hoy.toLocaleDateString('es-AR')}):\n\n${licenciasHoy.join('\n')}`;
      }

      if (tipo === 'consulta_trabajando') {
        const fechaKey = `${mesHoy}-${String(diaHoy).padStart(2, '0')}`;
        const trabajadores = TODOS_EMPLEADOS.filter(emp => {
          const tieneLicencia = licencias[emp.id]?.[fechaKey];
          return !tieneLicencia && trabajaDia(emp.id, diaHoy);
        });
        
        return `üë• Trabajando hoy (${hoy.toLocaleDateString('es-AR')}):\n\n${trabajadores.map(t => `‚úì ${t.nombre}`).join('\n')}`;
      }

      return 'ü§î No entend√≠ la consulta. Intenta: "quien tiene correos", "quien trabaja hoy", "quien tiene licencia"';
    }

    async function procesarAsignacion(tipo, comando) {
      const empleado = buscarEmpleado(comando);
      if (!empleado) {
        return { error: true, mensaje: '‚ùå No pude identificar al empleado.\nüí° Escribe el nombre o apellido del empleado.' };
      }

      const semana = extraerSemana(comando);
      if (!semana) {
        return { error: true, mensaje: '‚ùå No pude identificar la semana.\nüí° Especifica: "esta semana", "pr√≥xima semana", o "semana 43"' };
      }

      if (tipo === 'asignar_correo') {
        const turno = comando.match(/ma√±ana|manana/) ? 'ma√±ana' : 
                      comando.match(/tarde/) ? 'tarde' : null;
        
        if (!turno) {
          return { error: true, mensaje: '‚ùå Especifica el turno: "ma√±ana" o "tarde"' };
        }

        // Validar que el empleado est√© en el equipo de correos
        const equipoCorreo = turno === 'ma√±ana' ? EQUIPO_CORREOS_MANANA : EQUIPO_CORREOS_TARDE;
        if (!equipoCorreo.includes(empleado.id)) {
          return { error: true, mensaje: `‚ùå ${empleado.nombre} no est√° en el equipo de correos ${turno}` };
        }

        if (!tareas.correos[semana]) {
          tareas.correos[semana] = {};
        }
        
        tareas.correos[semana][turno] = empleado.id;
        await guardarFirebase();

        return { 
          error: false, 
          mensaje: `‚úÖ Asignaci√≥n exitosa!\n\nüìß ${empleado.nombre}\nTurno: ${turno === 'ma√±ana' ? 'üåÖ Ma√±ana' : 'üåÜ Tarde'}\nSemana: ${semana.split('-W')[1]}` 
        };
      }

      if (tipo === 'asignar_holdeo') {
        // Validar que el empleado est√© en el equipo de holdeos
        if (!EQUIPO_HOLDEOS.includes(empleado.id)) {
          return { error: true, mensaje: `‚ùå ${empleado.nombre} no est√° en el equipo de holdeos` };
        }

        tareas.holdeos[semana] = empleado.id;
        await guardarFirebase();

        return { 
          error: false, 
          mensaje: `‚úÖ Asignaci√≥n exitosa!\n\nüéØ ${empleado.nombre}\nHoldeo - Semana: ${semana.split('-W')[1]}` 
        };
      }

      return { error: true, mensaje: '‚ùå Tipo de asignaci√≥n no reconocido' };
    }

    async function procesarLicencia(comando) {
      const empleado = buscarEmpleado(comando);
      if (!empleado) {
        return { error: true, mensaje: '‚ùå No pude identificar al empleado.\nüí° Escribe el nombre completo o apellido del empleado.' };
      }

      const tipo = extraerTipoLicencia(comando);
      if (!tipo) {
        return { error: true, mensaje: `‚ùå No pude identificar el tipo de licencia para ${empleado.nombre}.\nüí° Especifica: vacaciones, enfermedad o examen.` };
      }

      const fechas = extraerFechas(comando);
      if (!fechas || fechas.length === 0) {
        return { error: true, mensaje: `‚ùå No pude encontrar fechas v√°lidas.\nüí° Usa formatos como: 10/11/2025, 10 de 11, o del 1 al 5 de noviembre.` };
      }

      const fechaInicio = fechas[0];
      const fechaFin = fechas.length > 1 ? fechas[fechas.length - 1] : fechaInicio;

      if (!licencias[empleado.id]) licencias[empleado.id] = {};
      
      const inicio = new Date(fechaInicio);
      const fin = new Date(fechaFin);
      
      let diasAgregados = 0;
      for (let d = new Date(inicio); d <= fin; d.setDate(d.getDate() + 1)) {
        const key = d.toISOString().split('T')[0];
        licencias[empleado.id][key] = tipo;
        diasAgregados++;
      }
      
      await guardarFirebase();
      
      const tipoEmoji = tipo === 'vacaciones' ? 'üèñÔ∏è' : tipo === 'enfermedad' ? 'üè•' : 'üìö';
      const inicioStr = new Date(fechaInicio).toLocaleDateString('es-AR');
      const finStr = new Date(fechaFin).toLocaleDateString('es-AR');
      
      return { 
        error: false, 
        mensaje: `‚úÖ Licencia registrada exitosamente!\n\n${tipoEmoji} ${empleado.nombre}\nTipo: ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}\nDesde: ${inicioStr}\nHasta: ${finStr}\nTotal: ${diasAgregados} d√≠a${diasAgregados > 1 ? 's' : ''}` 
      };
    }

    async function procesarComandoChat(comando) {
      procesandoChat = true;
      chatHistory.push({ role: 'user', text: comando });
      renderApp();

      try {
        const tipoComando = detectarTipoComando(comando);
        let resultado;

        if (tipoComando.startsWith('consulta_')) {
          resultado = await procesarConsulta(tipoComando, comando);
          chatHistory.push({ role: 'assistant', text: resultado });
        } else if (tipoComando.startsWith('asignar_')) {
          resultado = await procesarAsignacion(tipoComando, comando);
          chatHistory.push({ role: 'assistant', text: resultado.mensaje });
        } else if (tipoComando === 'agregar_licencia') {
          resultado = await procesarLicencia(comando);
          chatHistory.push({ role: 'assistant', text: resultado.mensaje });
        } else {
          chatHistory.push({ 
            role: 'assistant', 
            text: '‚ùì No entend√≠ el comando.\n\nüí° Puedes:\n‚Ä¢ Agregar licencias: "Lucas vacaciones del 1 al 5 de nov"\n‚Ä¢ Asignar correos: "Gabriel correos ma√±ana esta semana"\n‚Ä¢ Asignar holdeo: "Luna holdeo pr√≥xima semana"\n‚Ä¢ Consultar: "quien tiene correos", "quien trabaja hoy"' 
          });
        }

      } catch (error) {
        console.error('Error procesando comando:', error);
        chatHistory.push({ 
          role: 'assistant', 
          text: '‚ùå Hubo un error al procesar el comando. Intenta de nuevo.' 
        });
      }

      procesandoChat = false;
      renderApp();
    }

    // ===== EVENTOS =====
    window.cambiarVista = (vista) => { vistaActual = vista; renderApp(); };
    window.cambiarMes = (mes) => { mesSeleccionado = mes; renderApp(); };
    window.toggleFormLicencia = () => { mostrarFormLicencia = !mostrarFormLicencia; renderApp(); };
    window.toggleFormTareas = () => { mostrarFormTareas = !mostrarFormTareas; renderApp(); };
    window.toggleChat = () => { mostrarChat = !mostrarChat; renderApp(); };

    window.enviarComandoChat = async () => {
      const input = document.getElementById('chatInput');
      const comando = input.value.trim();
      
      if (!comando) return;
      
      input.value = '';
      await procesarComandoChat(comando);
    };

    window.limpiarChat = () => {
      chatHistory = [];
      renderApp();
    };

    window.agregarLicencia = async () => {
      const persona = document.getElementById('selectPersona').value;
      const tipo = document.getElementById('selectTipo').value;
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;

      if (!persona || !tipo || !fechaInicio) {
        alert('Completa todos los campos requeridos');
        return;
      }

      const inicio = new Date(fechaInicio);
      const fin = fechaFin ? new Date(fechaFin) : inicio;

      if (!licencias[persona]) licencias[persona] = {};

      for (let d = new Date(inicio); d <= fin; d.setDate(d.getDate() + 1)) {
        const key = d.toISOString().split('T')[0];
        licencias[persona][key] = tipo;
      }

      await guardarFirebase();
      mostrarFormLicencia = false;
      renderApp();
    };

    window.eliminarLicencia = async (personaId, fecha) => {
      if (licencias[personaId] && licencias[personaId][fecha]) {
        delete licencias[personaId][fecha];
        if (Object.keys(licencias[personaId]).length === 0) {
          delete licencias[personaId];
        }
        await guardarFirebase();
      }
    };

    window.asignarManual = async () => {
      const semana = document.getElementById('selectSemana').value;
      const correoMa√±ana = document.getElementById('selectCorreoMa√±ana').value;
      const correoTarde = document.getElementById('selectCorreoTarde').value;
      const holdeo = document.getElementById('selectHoldeo').value;

      if (!semana) {
        alert('Selecciona una semana');
        return;
      }

      if (correoMa√±ana || correoTarde) {
        tareas.correos[semana] = { 
          ma√±ana: correoMa√±ana || tareas.correos[semana]?.ma√±ana,
          tarde: correoTarde || tareas.correos[semana]?.tarde
        };
      }

      if (holdeo) {
        tareas.holdeos[semana] = holdeo;
      }

      await guardarFirebase();
      mostrarFormTareas = false;
      renderApp();
    };

    window.asignarAutomatico = async () => {
      const semanaActual = getSemanaActual();
      
      if (!tareas.correos[semanaActual]) {
        const ma√±ana = EQUIPO_CORREOS_MANANA[0];
        const tarde = EQUIPO_CORREOS_TARDE[0];
        tareas.correos[semanaActual] = { ma√±ana, tarde };
      }

      if (!tareas.holdeos[semanaActual]) {
        const holdeo = EQUIPO_HOLDEOS[0];
        tareas.holdeos[semanaActual] = holdeo;
      }

      await guardarFirebase();
    };

    window.limpiarAsignacion = async (tipo, semana) => {
      if (confirm('¬øEliminar esta asignaci√≥n?')) {
        if (tipo === 'correo') delete tareas.correos[semana];
        if (tipo === 'holdeo') delete tareas.holdeos[semana];
        await guardarFirebase();
      }
    };

    window.resetearContadores = async () => {
      if (confirm('¬øEst√°s seguro de que deseas resetear todos los contadores de correos? Esto eliminar√° todas las asignaciones de correos.')) {
        tareas.correos = {};
        await guardarFirebase();
        mostrarMensaje('‚úÖ Contadores reseteados');
      }
    };

    // ===== RENDERIZADORES =====
    function renderChatBox() {
      if (!mostrarChat) return '';

      return `
        <div class="fixed bottom-6 right-6 w-[420px] glass-card rounded-3xl shadow-2xl z-50 overflow-hidden">
          <div class="bg-gradient-to-r from-blue-500 to-purple-500 p-5 flex justify-between items-center">
            <div>
              <h3 class="font-semibold text-white text-lg">Chat Inteligente</h3>
              <p class="text-xs text-white/80">Gesti√≥n r√°pida por comandos</p>
            </div>
            <div class="flex gap-2">
              <button onclick="limpiarChat()" class="w-9 h-9 rounded-xl bg-white/20 hover:bg-white/30 flex items-center justify-center transition-all">
                <span class="text-white text-sm">üóëÔ∏è</span>
              </button>
              <button onclick="toggleChat()" class="w-9 h-9 rounded-xl bg-white/20 hover:bg-white/30 flex items-center justify-center transition-all">
                <span class="text-white text-lg">√ó</span>
              </button>
            </div>
          </div>
          
          <div class="h-96 overflow-y-auto p-5 space-y-4 bg-white/40 backdrop-blur-xl scroll-smooth">
            ${chatHistory.length === 0 ? `
              <div class="text-center mt-8">
                <div class="w-20 h-20 mx-auto mb-4 bg-gradient-to-br from-blue-100 to-purple-100 rounded-3xl flex items-center justify-center">
                  <span class="text-4xl">üí¨</span>
                </div>
                <p class="text-sm font-medium text-gray-700 mb-4">Chat Inteligente</p>
                <div class="space-y-4 text-xs bg-white/80 backdrop-blur-sm p-5 rounded-2xl text-left max-h-64 overflow-y-auto scroll-smooth">
                  <div>
                    <p class="font-semibold text-purple-600 mb-2 flex items-center gap-2">
                      <span>üèñÔ∏è</span> Agregar Licencias
                    </p>
                    <p class="text-gray-600 leading-relaxed">‚Ä¢ "Lucas vacaciones del 10/11/2025 al 15/11/2025"</p>
                    <p class="text-gray-600 leading-relaxed">‚Ä¢ "Deborah enfermedad 20/10/2025"</p>
                  </div>
                  
                  <div class="pt-3 border-t border-gray-200">
                    <p class="font-semibold text-blue-600 mb-2 flex items-center gap-2">
                      <span>üìß</span> Asignar Correos
                    </p>
                    <p class="text-gray-600 leading-relaxed">‚Ä¢ "Gabriel correos ma√±ana esta semana"</p>
                    <p class="text-gray-600 leading-relaxed">‚Ä¢ "Fernandez correos tarde pr√≥xima semana"</p>
                  </div>
                  
                  <div class="pt-3 border-t border-gray-200">
                    <p class="font-semibold text-purple-600 mb-2 flex items-center gap-2">
                      <span>üéØ</span> Asignar Holdeos
                    </p>
                    <p class="text-gray-600 leading-relaxed">‚Ä¢ "Luna holdeo esta semana"</p>
                    <p class="text-gray-600 leading-relaxed">‚Ä¢ "Guzman holdeo pr√≥xima semana"</p>
                  </div>
                  
                  <div class="pt-3 border-t border-gray-200">
                    <p class="font-semibold text-green-600 mb-2 flex items-center gap-2">
                      <span>üîç</span> Consultas
                    </p>
                    <p class="text-gray-600 leading-relaxed">‚Ä¢ "quien tiene correos"</p>
                    <p class="text-gray-600 leading-relaxed">‚Ä¢ "quien trabaja hoy"</p>
                  </div>
                </div>
              </div>
            ` : chatHistory.map(msg => `
              <div class="chat-message ${msg.role === 'user' ? 'text-right' : 'text-left'}">
                <div class="inline-block max-w-[85%] p-4 rounded-2xl ${
                  msg.role === 'user' 
                    ? 'bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-lg' 
                    : 'glass-card text-gray-700 shadow-md'
                }">
                  <p class="text-sm whitespace-pre-wrap leading-relaxed">${msg.text}</p>
                </div>
              </div>
            `).join('')}
            
            ${procesandoChat ? `
              <div class="text-center">
                <div class="inline-block glass-card p-4 rounded-2xl">
                  <div class="flex items-center gap-3">
                    <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"></div>
                    <div class="w-2 h-2 bg-purple-500 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                    <div class="w-2 h-2 bg-pink-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                  </div>
                </div>
              </div>
            ` : ''}
          </div>
          
          <div class="p-5 bg-white/60 backdrop-blur-xl border-t border-gray-200/50">
            <div class="flex gap-3">
              <input 
                type="text" 
                id="chatInput" 
                placeholder="Escribe un comando..."
                class="flex-1 px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-400 transition-all text-sm bg-white/80"
                onkeypress="if(event.key === 'Enter') enviarComandoChat()"
                ${procesandoChat ? 'disabled' : ''}
              >
              <button 
                onclick="enviarComandoChat()" 
                class="glass-button px-5 py-3 rounded-2xl font-medium hover-lift ${procesandoChat ? 'opacity-50 cursor-not-allowed' : ''}"
                ${procesandoChat ? 'disabled' : ''}
              >
                <span class="text-lg">üì§</span>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderFormLicencia() {
      if (!mostrarFormLicencia) return '';

      return `
        <div class="fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4" onclick="if(event.target === this) toggleFormLicencia()">
          <div class="glass-card rounded-3xl p-8 max-w-md w-full shadow-2xl">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-semibold text-gray-800">Agregar Licencia</h3>
              <button onclick="toggleFormLicencia()" class="w-10 h-10 rounded-xl glass-button hover-lift flex items-center justify-center text-gray-600">
                <span class="text-2xl">√ó</span>
              </button>
            </div>

            <div class="space-y-5">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Persona</label>
                <select id="selectPersona" class="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-400 transition-all bg-white">
                  <option value="">Seleccionar...</option>
                  ${TODOS_EMPLEADOS.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Licencia</label>
                <select id="selectTipo" class="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-400 transition-all bg-white">
                  <option value="">Seleccionar...</option>
                  <option value="vacaciones">üèñÔ∏è Vacaciones</option>
                  <option value="enfermedad">üè• Enfermedad</option>
                  <option value="examen">üìö Examen</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha Inicio</label>
                <input type="date" id="fechaInicio" class="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-400 transition-all bg-white">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha Fin (opcional)</label>
                <input type="date" id="fechaFin" class="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-400 transition-all bg-white">
              </div>

              <button onclick="agregarLicencia()" class="w-full glass-button py-4 rounded-2xl font-semibold text-blue-600 hover-lift mt-6">
                üíæ Guardar Licencia
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderFormTareas() {
      if (!mostrarFormTareas) return '';

      const semanasDisponibles = [];
      MESES_DISPONIBLES.forEach(mes => {
        getSemanasDelMes(mes.key).forEach(semana => {
          if (!semanasDisponibles.includes(semana)) {
            semanasDisponibles.push(semana);
          }
        });
      });

      return `
        <div class="fixed inset-0 bg-black/20 backdrop-blur-sm flex items-center justify-center z-50 p-4" onclick="if(event.target === this) toggleFormTareas()">
          <div class="glass-card rounded-3xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto scroll-smooth shadow-2xl">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-2xl font-semibold text-gray-800">Asignar Tareas</h3>
              <button onclick="toggleFormTareas()" class="w-10 h-10 rounded-xl glass-button hover-lift flex items-center justify-center text-gray-600">
                <span class="text-2xl">√ó</span>
              </button>
            </div>

            <div class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Semana</label>
                <select id="selectSemana" class="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-400 transition-all bg-white">
                  <option value="">Seleccionar semana...</option>
                  ${semanasDisponibles.map(s => {
                    const fecha = getFechaInicioSemana(s);
                    const fechaStr = fecha.toLocaleDateString('es-AR', { day: '2-digit', month: 'short' });
                    return `<option value="${s}">Semana ${s.split('-W')[1]} - ${fechaStr}</option>`;
                  }).join('')}
                </select>
              </div>

              <div class="bg-blue-50/50 rounded-2xl p-5">
                <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <span class="text-xl">üìß</span> Correos CABA
                </h4>
                
                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üåÖ Turno Ma√±ana</label>
                    <select id="selectCorreoMa√±ana" class="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-400 transition-all bg-white">
                      <option value="">No asignar</option>
                      ${EQUIPO_CORREOS_MANANA.map(id => {
                        const persona = TODOS_EMPLEADOS.find(p => p.id === id);
                        return `<option value="${id}">${persona.nombre}</option>`;
                      }).join('')}
                    </select>
                  </div>

                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üåÜ Turno Tarde</label>
                    <select id="selectCorreoTarde" class="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-400 transition-all bg-white">
                      <option value="">No asignar</option>
                      ${EQUIPO_CORREOS_TARDE.map(id => {
                        const persona = TODOS_EMPLEADOS.find(p => p.id === id);
                        return `<option value="${id}">${persona.nombre}</option>`;
                      }).join('')}
                    </select>
                  </div>
                </div>
              </div>

              <div class="bg-purple-50/50 rounded-2xl p-5">
                <h4 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <span class="text-xl">üéØ</span> Holdeo C√≥rdoba
                </h4>
                <select id="selectHoldeo" class="w-full px-4 py-3 rounded-2xl border-2 border-gray-200 focus:border-blue-400 transition-all bg-white">
                  <option value="">No asignar</option>
                  ${EQUIPO_HOLDEOS.map(id => {
                    const persona = TODOS_EMPLEADOS.find(p => p.id === id);
                    return `<option value="${id}">${persona.nombre}</option>`;
                  }).join('')}
                </select>
              </div>

              <button onclick="asignarManual()" class="w-full glass-button py-4 rounded-2xl font-semibold text-green-600 hover-lift">
                üíæ Guardar Asignaci√≥n
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderDashboard() {
      const hoy = new Date();
      const diaHoy = hoy.getDate();
      const mesHoy = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
      const semanaActual = getSemanaActual();

      const licenciasHoy = [];
      for (const [personaId, fechas] of Object.entries(licencias)) {
        const fechaKey = `${mesHoy}-${String(diaHoy).padStart(2, '0')}`;
        if (fechas[fechaKey]) {
          const persona = TODOS_EMPLEADOS.find(p => p.id === personaId);
          if (persona) {
            licenciasHoy.push({ nombre: persona.nombre, tipo: fechas[fechaKey] });
          }
        }
      }

      const correoActual = tareas.correos[semanaActual];
      const holdeoActual = tareas.holdeos[semanaActual];

      const getNombrePersona = (id) => {
        const persona = TODOS_EMPLEADOS.find(p => p.id === id);
        return persona ? persona.nombre : 'Sin asignar';
      };

      const diasTrabajados = calcularDiasTrabajados();
      const promedio = Object.values(diasTrabajados).reduce((a, b) => a + b, 0) / Object.keys(diasTrabajados).length;

      const feriadosMes = FERIADOS[mesSeleccionado] || [];
      
      const feriadosData = feriadosMes.map(dia => {
        const trabajadores = TODOS_EMPLEADOS.filter(p => {
          const fechaKey = getFechaKey(dia);
          const tieneLicencia = licencias[p.id]?.[fechaKey];
          return !tieneLicencia && trabajaDia(p.id, dia);
        });
        return { dia, nombre: getNombreFeriado(dia), trabajadores };
      });

      const semanasDelMes = getSemanasDelMes(mesSeleccionado);
      const asignacionesDelMes = semanasDelMes.map(semana => {
        const correo = tareas.correos[semana];
        const holdeo = tareas.holdeos[semana];
        const fecha = getFechaInicioSemana(semana);
        return { semana, fecha, correo, holdeo };
      });

      return `
        <div class="max-w-7xl mx-auto p-8">
          <div class="flex justify-between items-center mb-8">
            <div>
              <h2 class="text-2xl font-semibold text-gray-800 mb-2">Dashboard</h2>
              <select onchange="cambiarMes(this.value)" class="glass-button px-5 py-2.5 rounded-xl font-medium text-sm text-gray-700 cursor-pointer">
                ${MESES_DISPONIBLES.map(m => `<option value="${m.key}" ${m.key === mesSeleccionado ? 'selected' : ''}>${m.nombre}</option>`).join('')}
              </select>
            </div>
            <div class="flex gap-3">
              <button onclick="toggleChat()" class="glass-button px-5 py-3 rounded-xl font-medium text-sm text-purple-600 hover-lift">
                üí¨ Chat R√°pido
              </button>
              <button onclick="toggleFormLicencia()" class="glass-button px-5 py-3 rounded-xl font-medium text-sm text-blue-600 hover-lift">
                ‚ûï Licencia
              </button>
              <button onclick="toggleFormTareas()" class="glass-button px-5 py-3 rounded-xl font-medium text-sm text-green-600 hover-lift">
                üìã Asignar
              </button>
              <button onclick="asignarAutomatico()" class="glass-button px-5 py-3 rounded-xl font-medium text-sm text-indigo-600 hover-lift">
                ‚ú® Auto
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-card rounded-3xl p-6 hover-lift">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Licencias Hoy</h3>
                <span class="text-2xl">üèñÔ∏è</span>
              </div>
              ${licenciasHoy.length > 0 ? `
                <div class="space-y-2">
                  ${licenciasHoy.map(l => `
                    <div class="p-3 rounded-2xl ${
                      l.tipo === 'vacaciones' ? 'bg-purple-50' :
                      l.tipo === 'enfermedad' ? 'bg-red-50' : 'bg-blue-50'
                    }">
                      <span class="font-medium text-sm text-gray-700">${l.nombre}</span>
                      <span class="ml-2 text-sm">${
                        l.tipo === 'vacaciones' ? 'üèñÔ∏è' :
                        l.tipo === 'enfermedad' ? 'üè•' : 'üìö'
                      }</span>
                    </div>
                  `).join('')}
                </div>
              ` : '<p class="text-gray-400 text-sm">Sin licencias hoy</p>'}
            </div>

            <div class="glass-card rounded-3xl p-6 hover-lift">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Correos</h3>
                <div class="flex items-center gap-2">
                  <span class="text-2xl">üìß</span>
                  ${correoActual ? `<button onclick="limpiarAsignacion('correo', '${semanaActual}')" class="text-red-500 hover:text-red-700 text-sm">üóëÔ∏è</button>` : ''}
                </div>
              </div>
              <div class="space-y-3 text-sm">
                <div class="p-3 bg-blue-50 rounded-2xl">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-lg">üåÖ</span>
                    <strong class="text-gray-700">Ma√±ana</strong>
                  </div>
                  <span class="text-gray-600">${correoActual?.ma√±ana ? getNombrePersona(correoActual.ma√±ana) : 'Por asignar'}</span>
                </div>
                <div class="p-3 bg-indigo-50 rounded-2xl">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-lg">üåÜ</span>
                    <strong class="text-gray-700">Tarde</strong>
                  </div>
                  <span class="text-gray-600">${correoActual?.tarde ? getNombrePersona(correoActual.tarde) : 'Por asignar'}</span>
                </div>
              </div>
            </div>

            <div class="glass-card rounded-3xl p-6 hover-lift">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Holdeo</h3>
                <div class="flex items-center gap-2">
                  <span class="text-2xl">üéØ</span>
                  ${holdeoActual ? `<button onclick="limpiarAsignacion('holdeo', '${semanaActual}')" class="text-red-500 hover:text-red-700 text-sm">üóëÔ∏è</button>` : ''}
                </div>
              </div>
              <div class="p-4 bg-purple-50 rounded-2xl">
                <strong class="text-sm text-gray-700 block mb-1">Esta semana</strong>
                <span class="text-gray-600 text-sm">${holdeoActual ? getNombrePersona(holdeoActual) : 'Por asignar'}</span>
              </div>
            </div>
          </div>

          <div class="glass-card rounded-3xl p-8 mb-8 hover-lift">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-xl font-semibold text-gray-800">Contador de D√≠as en Correos</h3>
              <button onclick="resetearContadores()" class="glass-button px-4 py-2.5 rounded-xl text-sm font-medium text-red-600 hover-lift">
                üîÑ Resetear
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div>
                <h4 class="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                  <span class="text-xl">üåÖ</span> Turno Ma√±ana
                </h4>
                <div class="space-y-3">
                  ${EQUIPO_CORREOS_MANANA.map(id => {
                    const persona = TODOS_EMPLEADOS.find(p => p.id === id);
                    const dias = diasTrabajados[id] || 0;
                    const porcentaje = promedio > 0 ? ((dias / promedio) * 100).toFixed(0) : 100;
                    const color = dias < promedio - 2 ? 'blue' : 
                                  dias > promedio + 2 ? 'red' : 'green';
                    return `
                      <div class="bg-white/60 backdrop-blur-sm p-4 rounded-2xl border border-gray-100 smooth-shadow">
                        <div class="flex justify-between items-center mb-3">
                          <span class="font-medium text-gray-700">${persona.nombre}</span>
                          <span class="text-2xl font-bold text-${color}-600">${dias}</span>
                        </div>
                        <div class="bg-gray-100 rounded-full h-2.5 overflow-hidden">
                          <div class="bg-${color}-500 rounded-full h-2.5 transition-all duration-500" style="width: ${Math.min(porcentaje, 100)}%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">
                          ${dias < promedio - 2 ? '‚úÖ Prioritario' : 
                            dias > promedio + 2 ? '‚ö†Ô∏è Sobre promedio' : '‚úì Balanceado'}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>

              <div>
                <h4 class="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                  <span class="text-xl">üåÜ</span> Turno Tarde
                </h4>
                <div class="space-y-3">
                  ${EQUIPO_CORREOS_TARDE.map(id => {
                    const persona = TODOS_EMPLEADOS.find(p => p.id === id);
                    const dias = diasTrabajados[id] || 0;
                    const promTarde = (diasTrabajados['fernandez'] + diasTrabajados['meoniz']) / 2;
                    const porcentaje = promTarde > 0 ? ((dias / promTarde) * 100).toFixed(0) : 100;
                    const color = dias < promTarde - 2 ? 'blue' : 
                                  dias > promTarde + 2 ? 'red' : 'purple';
                    return `
                      <div class="bg-white/60 backdrop-blur-sm p-4 rounded-2xl border border-gray-100 smooth-shadow">
                        <div class="flex justify-between items-center mb-3">
                          <span class="font-medium text-gray-700">${persona.nombre}</span>
                          <span class="text-2xl font-bold text-${color}-600">${dias}</span>
                        </div>
                        <div class="bg-gray-100 rounded-full h-2.5 overflow-hidden">
                          <div class="bg-${color}-500 rounded-full h-2.5 transition-all duration-500" style="width: ${Math.min(porcentaje, 100)}%"></div>
                        </div>
                        <div class="text-xs text-gray-500 mt-2">
                          ${dias < promTarde - 2 ? '‚úÖ Prioritario' : 
                            dias > promTarde + 2 ? '‚ö†Ô∏è Sobre promedio' : '‚úì Balanceado'}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>

            <div class="mt-6 p-4 bg-blue-50/50 rounded-2xl border border-blue-100">
              <p class="text-sm text-gray-600 leading-relaxed">
                <strong class="text-gray-700">üí° Funcionamiento:</strong> El sistema cuenta d√≠as reales trabajados en correos y prioriza a quien tenga menos d√≠as al asignar autom√°ticamente.
                <br><strong class="text-gray-700 mt-2 block">üìã Cobertura:</strong>
                <span class="block mt-1">‚Ä¢ <strong>Lun-Vie:</strong> Equipos 5+1, 6x3 y C√≥rdoba</span>
                <span class="block">‚Ä¢ <strong>S√°bados:</strong> Equipos 5+1 (rotaci√≥n) o 6x3</span>
                <span class="block">‚Ä¢ <strong>Domingos y Feriados:</strong> Solo equipo 6x3</span>
              </p>
            </div>
          </div>

          <div class="glass-card rounded-3xl p-6 mb-8 hover-lift">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Asignaciones de ${getNombreMes()}</h3>
            <div class="overflow-x-auto scroll-smooth">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-gray-200">
                    <th class="p-4 text-left text-sm font-semibold text-gray-700">Semana</th>
                    <th class="p-4 text-left text-sm font-semibold text-gray-700">Correo Ma√±ana</th>
                    <th class="p-4 text-left text-sm font-semibold text-gray-700">Correo Tarde</th>
                    <th class="p-4 text-left text-sm font-semibold text-gray-700">Holdeo</th>
                  </tr>
                </thead>
                <tbody>
                  ${asignacionesDelMes.map(a => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50/50 transition-colors ${a.semana === semanaActual ? 'bg-green-50/50' : ''}">
                      <td class="p-4">
                        <div class="font-medium text-gray-800">Sem ${a.semana.split('-W')[1]}</div>
                        <div class="text-xs text-gray-500">${a.fecha.toLocaleDateString('es-AR', { day: '2-digit', month: 'short' })}</div>
                      </td>
                      <td class="p-4 text-sm text-gray-600">${a.correo?.ma√±ana ? getNombrePersona(a.correo.ma√±ana) : '-'}</td>
                      <td class="p-4 text-sm text-gray-600">${a.correo?.tarde ? getNombrePersona(a.correo.tarde) : '-'}</td>
                      <td class="p-4 text-sm text-gray-600">${a.holdeo ? getNombrePersona(a.holdeo) : '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>

          <div class="glass-card rounded-3xl p-6 hover-lift">
            <h3 class="text-xl font-semibold text-gray-800 mb-6">Feriados de ${getNombreMes()}</h3>
            ${feriadosData.length > 0 ? `
              <div class="space-y-4">
                ${feriadosData.map(f => `
                  <div class="bg-yellow-50/50 border-l-4 border-yellow-400 p-5 rounded-2xl">
                    <div class="font-semibold text-gray-800 mb-2 flex items-center gap-2">
                      <span class="text-xl">üéâ</span>
                      ${f.dia} ${getNombreDia(f.dia)} - ${f.nombre}
                    </div>
                    <div class="text-sm text-gray-600">
                      <strong>Trabajaron (${f.trabajadores.length}):</strong>
                      ${f.trabajadores.length > 0 ? 
                        f.trabajadores.map(t => t.nombre).join(', ') :
                        'Nadie trabaj√≥ este feriado'
                      }
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : '<p class="text-gray-400">No hay feriados en este mes</p>'}
          </div>
        </div>
      `;
    }

    function renderCelda(personaId, dia) {
      const fechaKey = getFechaKey(dia);
      const licencia = licencias[personaId]?.[fechaKey];
      const trabaja = trabajaDia(personaId, dia);
      const esSab = esSabado(dia);
      const esDom = esDomingo(dia);
      const esFer = esFeriado(dia);
      const tipo = getTipoTrabajo(personaId);

      let bgColor = 'bg-gray-100';
      let texto = '';

      if (licencia) {
        bgColor = licencia === 'vacaciones' ? 'bg-purple-500 text-white' :
                  licencia === 'enfermedad' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white';
        texto = licencia === 'vacaciones' ? 'üèñÔ∏è' :
                licencia === 'enfermedad' ? 'üè•' : 'üìö';
      } else if (tipo === '6x3') {
        if (trabaja) {
          if (esSab || esDom || esFer) {
            bgColor = 'bg-gradient-to-br from-yellow-400 to-yellow-500 text-white font-medium';
            texto = esFer ? 'FER' : esSab ? 'S√°b' : 'Dom';
          } else {
            bgColor = 'bg-gradient-to-br from-green-100 to-green-200 border-2 border-green-400';
            texto = '‚úì';
          }
        } else {
          bgColor = 'bg-gradient-to-br from-orange-400 to-orange-500 text-white';
          texto = 'F';
        }
      } else {
        if (esDom || esFer) {
          bgColor = 'bg-gray-200 text-gray-500';
          texto = esFer ? 'FER' : 'Dom';
        } else if (esSab && trabaja) {
          bgColor = 'bg-gradient-to-br from-yellow-400 to-yellow-500 text-white font-medium';
          texto = 'S√°b';
        } else if (esSab && !trabaja) {
          bgColor = 'bg-green-100';
          texto = '';
        } else if (trabaja) {
          bgColor = 'bg-gradient-to-br from-green-100 to-green-200 border-2 border-green-400';
          texto = '‚úì';
        } else {
          bgColor = 'bg-gradient-to-br from-orange-400 to-orange-500 text-white';
          texto = 'F';
        }
      }

      const deleteBtn = licencia ? `
        <button onclick="eliminarLicencia('${personaId}', '${fechaKey}')" 
                class="absolute -top-1 -right-1 w-6 h-6 bg-red-500 text-white text-xs rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600 flex items-center justify-center">
          √ó
        </button>
      ` : '';

      return `
        <td class="p-2 text-center relative group">
          <div class="${bgColor} rounded-xl p-3 text-sm font-medium relative transition-all hover:scale-105 shadow-sm">
            ${texto}
            ${deleteBtn}
          </div>
        </td>
      `;
    }

    function renderGrilla(titulo, equipo) {
      const diasMes = getDiasEnMes();
      const feriados = FERIADOS[mesSeleccionado] || [];

      return `
        <div class="max-w-7xl mx-auto p-8">
          <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-semibold text-gray-800">${titulo}</h2>
            <select onchange="cambiarMes(this.value)" class="glass-button px-5 py-2.5 rounded-xl font-medium text-sm text-gray-700 cursor-pointer">
              ${MESES_DISPONIBLES.map(m => `<option value="${m.key}" ${m.key === mesSeleccionado ? 'selected' : ''}>${m.nombre}</option>`).join('')}
            </select>
          </div>
          
          <div class="glass-card rounded-3xl overflow-hidden shadow-lg">
            <div class="overflow-x-auto scroll-smooth">
              <table class="w-full">
                <thead>
                  <tr class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-200">
                    <th class="p-4 text-left sticky left-0 bg-gradient-to-r from-gray-50 to-gray-100 font-semibold text-gray-700 text-sm">D√≠a</th>
                    ${equipo.map(p => `<th class="p-4 text-center font-medium text-gray-700 text-sm">${p.nombre}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${Array.from({length: diasMes}, (_, i) => i + 1).map(dia => {
                    const nombreDia = getNombreDia(dia);
                    const esFer = feriados.includes(dia);
                    const esFin = nombreDia === 'S√°b' || nombreDia === 'Dom';
                    const nombreFer = esFer ? getNombreFeriado(dia) : '';
                    
                    return `
                      <tr class="border-b border-gray-100 hover:bg-gray-50/50 transition-colors ${esFin ? 'bg-blue-50/30' : ''} ${esFer ? 'bg-yellow-50/30' : ''}">
                        <td class="p-4 font-medium sticky left-0 ${esFin ? 'bg-blue-50/30' : esFer ? 'bg-yellow-50/30' : 'bg-white'} backdrop-blur-sm">
                          <div class="flex flex-col">
                            <span class="text-gray-800">${dia} ${nombreDia}</span>
                            ${esFer ? `<span class="text-xs text-yellow-600 flex items-center gap-1 mt-1"><span>üéâ</span>${nombreFer}</span>` : ''}
                          </div>
                        </td>
                        ${equipo.map(p => renderCelda(p.id, dia)).join('')}
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>

          <div class="mt-6 glass-card rounded-2xl p-5">
            <p class="text-sm text-gray-600">
              <strong class="text-gray-700">Leyenda:</strong> 
              <span class="inline-flex items-center gap-1 ml-2">‚úì Trabaja</span>
              <span class="inline-flex items-center gap-1 ml-2">F Franco</span>
              <span class="inline-flex items-center gap-1 ml-2">üèñÔ∏è Vacaciones</span>
              <span class="inline-flex items-center gap-1 ml-2">üè• Enfermedad</span>
              <span class="inline-flex items-center gap-1 ml-2">üìö Examen</span>
              <span class="inline-flex items-center gap-1 ml-2">FER Feriado</span>
            </p>
          </div>
        </div>
      `;
    }

    function renderApp() {
      const app = document.getElementById('app');
      
      if (cargando) {
        app.innerHTML = `
          <div class="flex items-center justify-center h-screen">
            <div class="text-center glass-card p-12 rounded-3xl">
              <div class="relative w-20 h-20 mx-auto mb-6">
                <div class="absolute inset-0 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
              </div>
              <p class="text-xl font-medium text-gray-700">Cargando datos...</p>
            </div>
          </div>
        `;
        return;
      }
      
      const header = `
        <div class="glass-card border-b border-gray-200/50 sticky top-0 z-40">
          <div class="max-w-7xl mx-auto px-8 py-6">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h1 class="text-3xl font-semibold text-gray-800 mb-1">Sistema de Gesti√≥n</h1>
                <p class="text-sm text-gray-500">Gesti√≥n inteligente de turnos y licencias</p>
              </div>
              ${mensaje ? `
                <div class="glass-card px-6 py-3 rounded-2xl animate-pulse">
                  <span class="text-sm font-medium text-gray-700">${mensaje}</span>
                </div>
              ` : ''}
            </div>
            <nav class="flex gap-2">
              <button onclick="cambiarVista('dashboard')" class="nav-tab px-6 py-3 rounded-xl font-medium text-sm ${vistaActual === 'dashboard' ? 'active text-blue-600 bg-blue-50/50' : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50/50'}">
                Dashboard
              </button>
              <button onclick="cambiarVista('caba6x3')" class="nav-tab px-6 py-3 rounded-xl font-medium text-sm ${vistaActual === 'caba6x3' ? 'active text-blue-600 bg-blue-50/50' : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50/50'}">
                CABA 6x3
              </button>
              <button onclick="cambiarVista('caba5x1')" class="nav-tab px-6 py-3 rounded-xl font-medium text-sm ${vistaActual === 'caba5x1' ? 'active text-blue-600 bg-blue-50/50' : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50/50'}">
                CABA S√°bados
              </button>
              <button onclick="cambiarVista('cordoba')" class="nav-tab px-6 py-3 rounded-xl font-medium text-sm ${vistaActual === 'cordoba' ? 'active text-blue-600 bg-blue-50/50' : 'text-gray-600 hover:text-gray-900 hover:bg-gray-50/50'}">
                C√≥rdoba
              </button>
            </nav>
          </div>
        </div>
      `;

      let contenido = '';
      if (vistaActual === 'dashboard') contenido = renderDashboard();
      else if (vistaActual === 'caba6x3') contenido = renderGrilla('CABA - Rotaci√≥n 6x3', EQUIPOS.caba_6x3);
      else if (vistaActual === 'caba5x1') contenido = renderGrilla('CABA - S√°bados (5+1)', EQUIPOS.caba_5x1);
      else if (vistaActual === 'cordoba') contenido = renderGrilla('C√≥rdoba - S√°bados', EQUIPOS.cordoba);

      app.innerHTML = header + contenido + renderFormLicencia() + renderFormTareas() + renderChatBox();
    }

    renderApp();
  </script>
</body>
</html>
