<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de GestiÃ³n de Turnos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <div id="app"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, doc, setDoc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // FIREBASE CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyBTM4YLyNUxNCg8SoTrTwqHd-_r386PSPE",
      authDomain: "turnos-caba-cordoba.firebaseapp.com",
      projectId: "turnos-caba-cordoba",
      storageBucket: "turnos-caba-cordoba.firebasestorage.app",
      messagingSenderId: "801338083327",
      appId: "1:801338083327:web:67ea89fee2ef6e875de3ca"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ===== ESTADO GLOBAL =====
    let licencias = {};
    let tareas = { correos: {}, holdeos: {} };
    let vistaActual = 'dashboard';
    let mesSeleccionado = '2025-10';
    let mostrarFormLicencia = false;
    let mostrarFormTareas = false;
    let mensaje = '';
    let cargando = true;

    // ===== CONFIGURACIÃ“N =====
    const MESES_DISPONIBLES = [
      { key: '2025-10', nombre: 'Octubre 2025', dias: 31 },
      { key: '2025-11', nombre: 'Noviembre 2025', dias: 30 },
      { key: '2025-12', nombre: 'Diciembre 2025', dias: 31 },
      { key: '2026-01', nombre: 'Enero 2026', dias: 31 },
      { key: '2026-02', nombre: 'Febrero 2026', dias: 28 },
      { key: '2026-03', nombre: 'Marzo 2026', dias: 31 },
      { key: '2026-04', nombre: 'Abril 2026', dias: 30 },
      { key: '2026-05', nombre: 'Mayo 2026', dias: 31 },
      { key: '2026-06', nombre: 'Junio 2026', dias: 30 }
    ];

    const FERIADOS = {
      '2025-10': [12],
      '2025-11': [20],
      '2025-12': [8, 25],
      '2026-01': [1],
      '2026-02': [16, 17],
      '2026-03': [24],
      '2026-04': [2, 3],
      '2026-05': [1, 25],
      '2026-06': [15, 20]
    };

    const NOMBRES_FERIADOS = {
      '2025-10-12': 'Respeto a la Diversidad Cultural',
      '2025-11-20': 'DÃ­a de la SoberanÃ­a Nacional',
      '2025-12-08': 'Inmaculada ConcepciÃ³n',
      '2025-12-25': 'Navidad',
      '2026-01-01': 'AÃ±o Nuevo',
      '2026-02-16': 'Carnaval',
      '2026-02-17': 'Carnaval',
      '2026-03-24': 'Memoria por la Verdad y la Justicia',
      '2026-04-02': 'DÃ­a del Veterano y Malvinas',
      '2026-04-03': 'Viernes Santo',
      '2026-05-01': 'DÃ­a del Trabajador',
      '2026-05-25': 'RevoluciÃ³n de Mayo',
      '2026-06-15': 'Gral. MartÃ­n Miguel de GÃ¼emes',
      '2026-06-20': 'Gral. Manuel Belgrano'
    };

    const EQUIPOS = {
      caba_5x1: [
        { id: 'lottero', nombre: 'Lottero, Lucas', turno: 'maÃ±ana' },
        { id: 'lopez', nombre: 'LÃ³pez, Deborah', turno: 'maÃ±ana', excluirCorreos: true },
        { id: 'capdet', nombre: 'Capdet, Gustavo', turno: 'maÃ±ana' },
        { id: 'torales', nombre: 'Torales, AndrÃ©s', turno: 'maÃ±ana' },
        { id: 'fernandez', nombre: 'FernÃ¡ndez, NicolÃ¡s', turno: 'tarde' }
      ],
      caba_6x3: [
        { id: 'gabriel', nombre: 'Palazzini, Gabriel', turno: 'maÃ±ana' },
        { id: 'meoniz', nombre: 'Meoniz, NicolÃ¡s', turno: 'tarde' },
        { id: 'sergio', nombre: 'Palacios, Sergio', turno: 'maÃ±ana' }
      ],
      cordoba: [
        { id: 'guzman', nombre: 'GuzmÃ¡n, Luis' },
        { id: 'luna', nombre: 'Luna, MartÃ­n' },
        { id: 'diaz_s', nombre: 'DÃ­az, SebastiÃ¡n' },
        { id: 'poles', nombre: 'Poles, Marina' },
        { id: 'diaz_j', nombre: 'DÃ­az, Jorge' },
        { id: 'allende', nombre: 'Allende, Alejandro' },
        { id: 'pereyra', nombre: 'Pereyra, JosÃ©' },
        { id: 'spicogna', nombre: 'Spicogna, Ariel' },
        { id: 'garrafa', nombre: 'Garrafa, Nico' },
        { id: 'baldamus', nombre: 'Baldamus, Gabriela' }
      ]
    };

    const TODOS_EMPLEADOS = [...EQUIPOS.caba_5x1, ...EQUIPOS.caba_6x3, ...EQUIPOS.cordoba];

    const ROTACION_CABA_SABADOS = ['lopez', 'capdet', 'torales', 'fernandez', 'lottero'];
    const ROTACION_CORDOBA_SABADOS = [
      ['luna', 'spicogna'],
      ['diaz_s', 'diaz_j', 'baldamus', 'allende'],
      ['guzman', 'pereyra'],
      ['poles']
    ];

    const INICIO_6X3 = {
      gabriel: new Date(2025, 9, 11),
      meoniz: new Date(2025, 9, 11),
      sergio: new Date(2025, 9, 6)
    };

    const EQUIPO_CORREOS_MANANA = ['lottero', 'capdet', 'torales', 'gabriel', 'sergio'];
    const EQUIPO_CORREOS_TARDE = ['fernandez', 'meoniz'];
    const EQUIPO_HOLDEOS = ['guzman', 'luna', 'diaz_s', 'poles', 'diaz_j', 'allende', 'pereyra', 'spicogna', 'garrafa', 'baldamus'];

    // ===== FIREBASE SYNC =====
    onSnapshot(doc(db, 'turnos', 'datos'), (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        licencias = data.licencias || {};
        tareas = data.tareas || { correos: {}, holdeos: {} };
        console.log('âœ… Datos cargados desde Firebase:', data);
      } else {
        console.log('ğŸ“ Creando documento inicial en Firebase...');
        // Crear documento inicial si no existe
        guardarFirebase();
      }
      cargando = false;
      renderApp();
    }, (error) => {
      console.error('âŒ Error Firebase:', error);
      cargando = false;
      renderApp();
    });

    async function guardarFirebase() {
      try {
        const datos = {
          licencias,
          tareas,
          ultimaActualizacion: new Date().toISOString()
        };
        await setDoc(doc(db, 'turnos', 'datos'), datos);
        console.log('âœ… Guardado en Firebase:', datos);
        mostrarMensaje('âœ… Guardado');
        return true;
      } catch (error) {
        console.error('âŒ Error al guardar:', error);
        mostrarMensaje('âŒ Error al guardar');
        return false;
      }
    }

    function mostrarMensaje(msg) {
      mensaje = msg;
      renderApp();
      setTimeout(() => { mensaje = ''; renderApp(); }, 3000);
    }

    // ===== UTILIDADES =====
    function getNombreDia(dia) {
      const [aÃ±o, mes] = mesSeleccionado.split('-');
      const fecha = new Date(aÃ±o, mes - 1, dia);
      return ['Dom', 'Lun', 'Mar', 'MiÃ©', 'Jue', 'Vie', 'SÃ¡b'][fecha.getDay()];
    }

    function esSabado(dia) { return getNombreDia(dia) === 'SÃ¡b'; }
    function esDomingo(dia) { return getNombreDia(dia) === 'Dom'; }
    function esFeriado(dia) { return (FERIADOS[mesSeleccionado] || []).includes(dia); }

    function getDiasEnMes() {
      const mesInfo = MESES_DISPONIBLES.find(m => m.key === mesSeleccionado);
      return mesInfo ? mesInfo.dias : 31;
    }

    function getNombreMes() {
      const mesInfo = MESES_DISPONIBLES.find(m => m.key === mesSeleccionado);
      return mesInfo ? mesInfo.nombre : mesSeleccionado;
    }

    function getFechaKey(dia) {
      const [aÃ±o, mes] = mesSeleccionado.split('-');
      return `${aÃ±o}-${mes}-${String(dia).padStart(2, '0')}`;
    }

    function getNombreFeriado(dia) {
      const fechaKey = getFechaKey(dia);
      return NOMBRES_FERIADOS[fechaKey] || 'Feriado Nacional';
    }

    function getSemanaISO(fecha) {
      const d = new Date(fecha);
      const dayNum = d.getDay() || 7;
      d.setDate(d.getDate() + 4 - dayNum);
      const yearStart = new Date(d.getFullYear(), 0, 1);
      const weekNum = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return `${d.getFullYear()}-W${String(weekNum).padStart(2, '0')}`;
    }

    function getSemanaActual() {
      return getSemanaISO(new Date());
    }

    function getFechaInicioSemana(semanaISO) {
      const [aÃ±o, semana] = semanaISO.split('-W');
      const fecha = new Date(aÃ±o, 0, 1 + (semana - 1) * 7);
      const dia = fecha.getDay();
      const diff = fecha.getDate() - dia + (dia === 0 ? -6 : 1);
      return new Date(fecha.setDate(diff));
    }

    function getSemanasDelMes(mes) {
      const [aÃ±o, mesNum] = mes.split('-');
      const diasMes = MESES_DISPONIBLES.find(m => m.key === mes)?.dias || 31;
      const semanas = new Set();
      
      for (let dia = 1; dia <= diasMes; dia++) {
        const fecha = new Date(aÃ±o, mesNum - 1, dia);
        semanas.add(getSemanaISO(fecha));
      }
      
      return Array.from(semanas).sort();
    }

    function trabaja5x1(personaId, dia) {
      // Si es feriado, NO trabaja (excepto 6x3)
      if (esFeriado(dia)) return false;
      
      if (esDomingo(dia)) return false;
      if (!esSabado(dia)) return true;
      
      const primerSabado = new Date(2025, 9, 4);
      const [aÃ±o, mes] = mesSeleccionado.split('-');
      const fechaActual = new Date(aÃ±o, mes - 1, dia);
      const difDias = Math.floor((fechaActual - primerSabado) / (24 * 60 * 60 * 1000));
      const semanas = Math.floor(difDias / 7);
      const indice = semanas % ROTACION_CABA_SABADOS.length;
      
      return ROTACION_CABA_SABADOS[indice] === personaId;
    }

    function trabajaCordoba(personaId, dia) {
      // Si es feriado, NO trabaja (excepto 6x3)
      if (esFeriado(dia)) return false;
      
      if (esDomingo(dia)) return false;
      if (!esSabado(dia)) return true;
      
      const primerSabado = new Date(2025, 9, 4);
      const [aÃ±o, mes] = mesSeleccionado.split('-');
      const fechaActual = new Date(aÃ±o, mes - 1, dia);
      const difDias = Math.floor((fechaActual - primerSabado) / (24 * 60 * 60 * 1000));
      const semanas = Math.floor(difDias / 7);
      const indice = semanas % ROTACION_CORDOBA_SABADOS.length;
      
      return ROTACION_CORDOBA_SABADOS[indice].includes(personaId);
    }

    function trabaja6x3(personaId, dia) {
      const [aÃ±o, mes] = mesSeleccionado.split('-');
      const fechaActual = new Date(aÃ±o, mes - 1, dia);
      const inicioPersona = INICIO_6X3[personaId];
      
      if (!inicioPersona) return true;
      
      const difDias = Math.floor((fechaActual - inicioPersona) / (24 * 60 * 60 * 1000));
      const posicionEnCiclo = ((difDias % 9) + 9) % 9;
      
      return posicionEnCiclo >= 3;
    }

    function getTipoTrabajo(personaId) {
      if (EQUIPOS.caba_6x3.find(p => p.id === personaId)) return '6x3';
      if (EQUIPOS.cordoba.find(p => p.id === personaId)) return 'cordoba';
      return '5x1';
    }

    function trabajaDia(personaId, dia) {
      const tipo = getTipoTrabajo(personaId);
      if (tipo === '6x3') return trabaja6x3(personaId, dia);
      if (tipo === 'cordoba') return trabajaCordoba(personaId, dia);
      return trabaja5x1(personaId, dia);
    }

    // ===== EVENTOS =====
    window.cambiarVista = (vista) => { vistaActual = vista; renderApp(); };
    window.cambiarMes = (mes) => { mesSeleccionado = mes; renderApp(); };
    window.toggleFormLicencia = () => { mostrarFormLicencia = !mostrarFormLicencia; renderApp(); };
    window.toggleFormTareas = () => { mostrarFormTareas = !mostrarFormTareas; renderApp(); };

    window.agregarLicencia = async () => {
      const persona = document.getElementById('selectPersona').value;
      const tipo = document.getElementById('selectTipo').value;
      const fechaInicio = document.getElementById('fechaInicio').value;
      const fechaFin = document.getElementById('fechaFin').value;

      if (!persona || !tipo || !fechaInicio) {
        alert('Completa todos los campos requeridos');
        return;
      }

      const inicio = new Date(fechaInicio);
      const fin = fechaFin ? new Date(fechaFin) : inicio;

      if (!licencias[persona]) licencias[persona] = {};

      for (let d = new Date(inicio); d <= fin; d.setDate(d.getDate() + 1)) {
        const key = d.toISOString().split('T')[0];
        licencias[persona][key] = tipo;
      }

      await guardarFirebase();
      mostrarFormLicencia = false;
      renderApp();
    };

    window.eliminarLicencia = async (personaId, fecha) => {
      if (licencias[personaId] && licencias[personaId][fecha]) {
        delete licencias[personaId][fecha];
        if (Object.keys(licencias[personaId]).length === 0) {
          delete licencias[personaId];
        }
        await guardarFirebase();
      }
    };

    window.asignarManual = async () => {
      const semana = document.getElementById('selectSemana').value;
      const correoMaÃ±ana = document.getElementById('selectCorreoMaÃ±ana').value;
      const correoTarde = document.getElementById('selectCorreoTarde').value;
      const holdeo = document.getElementById('selectHoldeo').value;

      if (!semana) {
        alert('Selecciona una semana');
        return;
      }

      if (correoMaÃ±ana || correoTarde) {
        tareas.correos[semana] = { 
          maÃ±ana: correoMaÃ±ana || tareas.correos[semana]?.maÃ±ana,
          tarde: correoTarde || tareas.correos[semana]?.tarde
        };
      }

      if (holdeo) {
        tareas.holdeos[semana] = holdeo;
      }

      await guardarFirebase();
      mostrarFormTareas = false;
      renderApp();
    };

    window.asignarAutomatico = async () => {
      const semanaActual = getSemanaActual();
      
      if (!tareas.correos[semanaActual]) {
        const maÃ±ana = EQUIPO_CORREOS_MANANA[0];
        const tarde = EQUIPO_CORREOS_TARDE[0];
        tareas.correos[semanaActual] = { maÃ±ana, tarde };
      }

      if (!tareas.holdeos[semanaActual]) {
        const holdeo = EQUIPO_HOLDEOS[0];
        tareas.holdeos[semanaActual] = holdeo;
      }

      await guardarFirebase();
    };

    window.limpiarAsignacion = async (tipo, semana) => {
      if (confirm('Â¿Eliminar esta asignaciÃ³n?')) {
        if (tipo === 'correo') delete tareas.correos[semana];
        if (tipo === 'holdeo') delete tareas.holdeos[semana];
        await guardarFirebase();
      }
    };

    // ===== RENDERIZADORES =====
    function renderFormLicencia() {
      if (!mostrarFormLicencia) return '';

      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) toggleFormLicencia()">
          <div class="bg-white rounded-lg shadow-2xl p-6 max-w-md w-full m-4">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-2xl font-bold">â• Agregar Licencia</h3>
              <button onclick="toggleFormLicencia()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
            </div>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold mb-2">ğŸ‘¤ Persona</label>
                <select id="selectPersona" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                  <option value="">Seleccionar...</option>
                  ${TODOS_EMPLEADOS.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                </select>
              </div>

              <div>
                <label class="block text-sm font-semibold mb-2">ğŸ“‹ Tipo de Licencia</label>
                <select id="selectTipo" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                  <option value="">Seleccionar...</option>
                  <option value="vacaciones">ğŸ–ï¸ Vacaciones</option>
                  <option value="enfermedad">ğŸ¥ Enfermedad</option>
                  <option value="examen">ğŸ“š Examen</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-semibold mb-2">ğŸ“… Fecha Inicio</label>
                <input type="date" id="fechaInicio" class="w-full p-3 border-2 border-gray-300 rounded-lg">
              </div>

              <div>
                <label class="block text-sm font-semibold mb-2">ğŸ“… Fecha Fin (opcional)</label>
                <input type="date" id="fechaFin" class="w-full p-3 border-2 border-gray-300 rounded-lg">
              </div>

              <button onclick="agregarLicencia()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">
                ğŸ’¾ Guardar Licencia
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderFormTareas() {
      if (!mostrarFormTareas) return '';

      const semanasDisponibles = [];
      MESES_DISPONIBLES.forEach(mes => {
        getSemanasDelMes(mes.key).forEach(semana => {
          if (!semanasDisponibles.includes(semana)) {
            semanasDisponibles.push(semana);
          }
        });
      });

      return `
        <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) toggleFormTareas()">
          <div class="bg-white rounded-lg shadow-2xl p-6 max-w-2xl w-full m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-2xl font-bold">ğŸ“‹ Asignar Tareas</h3>
              <button onclick="toggleFormTareas()" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
            </div>

            <div class="space-y-4">
              <div>
                <label class="block text-sm font-semibold mb-2">ğŸ“… Semana</label>
                <select id="selectSemana" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                  <option value="">Seleccionar semana...</option>
                  ${semanasDisponibles.map(s => {
                    const fecha = getFechaInicioSemana(s);
                    const fechaStr = fecha.toLocaleDateString('es-AR', { day: '2-digit', month: 'short' });
                    return `<option value="${s}">Semana ${s.split('-W')[1]} - ${fechaStr}</option>`;
                  }).join('')}
                </select>
              </div>

              <div class="border-t pt-4">
                <h4 class="font-bold text-lg mb-3 text-blue-600">ğŸ“§ Correos CABA</h4>
                
                <div class="mb-3">
                  <label class="block text-sm font-semibold mb-2">ğŸŒ… Turno MaÃ±ana</label>
                  <select id="selectCorreoMaÃ±ana" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                    <option value="">No asignar</option>
                    ${EQUIPO_CORREOS_MANANA.map(id => {
                      const persona = TODOS_EMPLEADOS.find(p => p.id === id);
                      return `<option value="${id}">${persona.nombre}</option>`;
                    }).join('')}
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-semibold mb-2">ğŸŒ† Turno Tarde</label>
                  <select id="selectCorreoTarde" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                    <option value="">No asignar</option>
                    ${EQUIPO_CORREOS_TARDE.map(id => {
                      const persona = TODOS_EMPLEADOS.find(p => p.id === id);
                      return `<option value="${id}">${persona.nombre}</option>`;
                    }).join('')}
                  </select>
                </div>
              </div>

              <div class="border-t pt-4">
                <h4 class="font-bold text-lg mb-3 text-purple-600">ğŸ¯ Holdeo CÃ³rdoba</h4>
                <select id="selectHoldeo" class="w-full p-3 border-2 border-gray-300 rounded-lg">
                  <option value="">No asignar</option>
                  ${EQUIPO_HOLDEOS.map(id => {
                    const persona = TODOS_EMPLEADOS.find(p => p.id === id);
                    return `<option value="${id}">${persona.nombre}</option>`;
                  }).join('')}
                </select>
              </div>

              <button onclick="asignarManual()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">
                ğŸ’¾ Guardar AsignaciÃ³n
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderDashboard() {
      const hoy = new Date();
      const diaHoy = hoy.getDate();
      const mesHoy = `${hoy.getFullYear()}-${String(hoy.getMonth() + 1).padStart(2, '0')}`;
      const semanaActual = getSemanaActual();

      const licenciasHoy = [];
      for (const [personaId, fechas] of Object.entries(licencias)) {
        const fechaKey = `${mesHoy}-${String(diaHoy).padStart(2, '0')}`;
        if (fechas[fechaKey]) {
          const persona = TODOS_EMPLEADOS.find(p => p.id === personaId);
          if (persona) {
            licenciasHoy.push({ nombre: persona.nombre, tipo: fechas[fechaKey] });
          }
        }
      }

      const correoActual = tareas.correos[semanaActual];
      const holdeoActual = tareas.holdeos[semanaActual];

      const getNombrePersona = (id) => {
        const persona = TODOS_EMPLEADOS.find(p => p.id === id);
        return persona ? persona.nombre : 'Sin asignar';
      };

      // Calcular dÃ­as trabajados
      const diasTrabajados = calcularDiasTrabajados();
      const promedio = Object.values(diasTrabajados).reduce((a, b) => a + b, 0) / Object.keys(diasTrabajados).length;

      const feriadosMes = FERIADOS[mesSeleccionado] || [];
      
      const feriadosData = feriadosMes.map(dia => {
        const trabajadores = TODOS_EMPLEADOS.filter(p => {
          const fechaKey = getFechaKey(dia);
          const tieneLicencia = licencias[p.id]?.[fechaKey];
          return !tieneLicencia && trabajaDia(p.id, dia);
        });
        return { dia, nombre: getNombreFeriado(dia), trabajadores };
      });

      const semanasDelMes = getSemanasDelMes(mesSeleccionado);
      const asignacionesDelMes = semanasDelMes.map(semana => {
        const correo = tareas.correos[semana];
        const holdeo = tareas.holdeos[semana];
        const fecha = getFechaInicioSemana(semana);
        return { semana, fecha, correo, holdeo };
      });

      return `
        <div class="max-w-7xl mx-auto p-6">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h2 class="text-3xl font-bold text-gray-800">ğŸ“Š Dashboard Principal</h2>
              <div class="mt-2">
                <select onchange="cambiarMes(this.value)" class="px-4 py-2 border-2 border-gray-300 rounded-lg font-semibold bg-white">
                  ${MESES_DISPONIBLES.map(m => `<option value="${m.key}" ${m.key === mesSeleccionado ? 'selected' : ''}>${m.nombre}</option>`).join('')}
                </select>
              </div>
            </div>
            <div class="flex gap-3">
              <button onclick="toggleFormLicencia()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg">
                â• Licencia
              </button>
              <button onclick="toggleFormTareas()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg">
                ğŸ“‹ Asignar
              </button>
              <button onclick="asignarAutomatico()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-bold shadow-lg">
                ğŸ¤– Auto
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
              <h3 class="text-xl font-bold mb-4 text-blue-600">ğŸ–ï¸ Licencias Hoy</h3>
              ${licenciasHoy.length > 0 ? `
                <div class="space-y-2">
                  ${licenciasHoy.map(l => `
                    <div class="p-3 rounded ${
                      l.tipo === 'vacaciones' ? 'bg-purple-100' :
                      l.tipo === 'enfermedad' ? 'bg-red-100' : 'bg-blue-100'
                    }">
                      <span class="font-semibold text-sm">${l.nombre}</span>
                      <span class="ml-2 text-xs">${
                        l.tipo === 'vacaciones' ? 'ğŸ–ï¸' :
                        l.tipo === 'enfermedad' ? 'ğŸ¥' : 'ğŸ“š'
                      }</span>
                    </div>
                  `).join('')}
                </div>
              ` : '<p class="text-gray-500 text-sm">Sin licencias hoy</p>'}
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-blue-600">ğŸ“§ Correos</h3>
                ${correoActual ? `<button onclick="limpiarAsignacion('correo', '${semanaActual}')" class="text-red-500 hover:text-red-700 text-sm">ğŸ—‘ï¸</button>` : ''}
              </div>
              <div class="space-y-2 text-sm">
                <div class="p-2 bg-blue-50 rounded">
                  <strong>ğŸŒ… MaÃ±ana:</strong><br>
                  <span class="text-blue-700">${correoActual?.maÃ±ana ? getNombrePersona(correoActual.maÃ±ana) : 'Por asignar'}</span>
                </div>
                <div class="p-2 bg-blue-50 rounded">
                  <strong>ğŸŒ† Tarde:</strong><br>
                  <span class="text-blue-700">${correoActual?.tarde ? getNombrePersona(correoActual.tarde) : 'Por asignar'}</span>
                </div>
              </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
              <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-600">ğŸ¯ Holdeo</h3>
                ${holdeoActual ? `<button onclick="limpiarAsignacion('holdeo', '${semanaActual}')" class="text-red-500 hover:text-red-700 text-sm">ğŸ—‘ï¸</button>` : ''}
              </div>
              <div class="p-3 bg-purple-50 rounded">
                <strong>Esta semana:</strong><br>
                <span class="text-purple-700">${holdeoActual ? getNombrePersona(holdeoActual) : 'Por asignar'}</span>
              </div>
            </div>
          </div>

          <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg shadow-md p-6 mb-8 border-2 border-blue-200">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-2xl font-bold text-blue-800">ğŸ“Š Contador de DÃ­as en Correos CABA</h3>
              <button onclick="resetearContadores()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold">
                ğŸ”„ Resetear
              </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <h4 class="font-bold text-lg mb-3 text-blue-700">ğŸŒ… Turno MaÃ±ana</h4>
                <div class="space-y-2">
                  ${EQUIPO_CORREOS_MANANA.map(id => {
                    const persona = TODOS_EMPLEADOS.find(p => p.id === id);
                    const dias = diasTrabajados[id] || 0;
                    const porcentaje = promedio > 0 ? ((dias / promedio) * 100).toFixed(0) : 100;
                    const color = dias < promedio - 2 ? 'bg-green-500' : 
                                  dias > promedio + 2 ? 'bg-red-500' : 'bg-blue-500';
                    return `
                      <div class="bg-white p-3 rounded-lg shadow border-l-4 ${color.replace('bg-', 'border-')}">
                        <div class="flex justify-between items-center">
                          <span class="font-semibold">${persona.nombre}</span>
                          <span class="text-2xl font-bold ${color.replace('bg-', 'text-')}">${dias}</span>
                        </div>
                        <div class="mt-2 bg-gray-200 rounded-full h-2">
                          <div class="${color} rounded-full h-2" style="width: ${Math.min(porcentaje, 100)}%"></div>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                          ${dias < promedio - 2 ? 'âœ… Prioritario para asignaciÃ³n' : 
                            dias > promedio + 2 ? 'âš ï¸ Sobre promedio' : 'âœ“ Balanceado'}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>

              <div>
                <h4 class="font-bold text-lg mb-3 text-purple-700">ğŸŒ† Turno Tarde</h4>
                <div class="space-y-2">
                  ${EQUIPO_CORREOS_TARDE.map(id => {
                    const persona = TODOS_EMPLEADOS.find(p => p.id === id);
                    const dias = diasTrabajados[id] || 0;
                    const promTarde = (diasTrabajados['fernandez'] + diasTrabajados['meoniz']) / 2;
                    const porcentaje = promTarde > 0 ? ((dias / promTarde) * 100).toFixed(0) : 100;
                    const color = dias < promTarde - 2 ? 'bg-green-500' : 
                                  dias > promTarde + 2 ? 'bg-red-500' : 'bg-purple-500';
                    return `
                      <div class="bg-white p-3 rounded-lg shadow border-l-4 ${color.replace('bg-', 'border-')}">
                        <div class="flex justify-between items-center">
                          <span class="font-semibold">${persona.nombre}</span>
                          <span class="text-2xl font-bold ${color.replace('bg-', 'text-')}">${dias}</span>
                        </div>
                        <div class="mt-2 bg-gray-200 rounded-full h-2">
                          <div class="${color} rounded-full h-2" style="width: ${Math.min(porcentaje, 100)}%"></div>
                        </div>
                        <div class="text-xs text-gray-600 mt-1">
                          ${dias < promTarde - 2 ? 'âœ… Prioritario para asignaciÃ³n' : 
                            dias > promTarde + 2 ? 'âš ï¸ Sobre promedio' : 'âœ“ Balanceado'}
                        </div>
                      </div>
                    `;
                  }).join('')}
                </div>
              </div>
            </div>

            <div class="mt-4 p-3 bg-white rounded-lg border border-blue-300">
              <p class="text-sm text-gray-700">
                <strong>ğŸ’¡ CÃ³mo funciona:</strong> El sistema cuenta dÃ­as REALES trabajados en correos. 
                Al asignar automÃ¡ticamente, prioriza a quien tenga menos dÃ­as. 
                Los fines de semana/feriados solo pueden ser cubiertos por el equipo 6x3.
              </p>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <h3 class="text-xl font-bold mb-4">ğŸ“… Asignaciones de ${getNombreMes()}</h3>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="bg-gray-100">
                    <th class="p-3 text-left">Semana</th>
                    <th class="p-3 text-left">Correo MaÃ±ana</th>
                    <th class="p-3 text-left">Correo Tarde</th>
                    <th class="p-3 text-left">Holdeo</th>
                  </tr>
                </thead>
                <tbody>
                  ${asignacionesDelMes.map(a => `
                    <tr class="border-t ${a.semana === semanaActual ? 'bg-green-50' : ''}">
                      <td class="p-3 font-semibold">
                        Sem ${a.semana.split('-W')[1]}<br>
                        <span class="text-xs text-gray-600">${a.fecha.toLocaleDateString('es-AR', { day: '2-digit', month: 'short' })}</span>
                      </td>
                      <td class="p-3 text-sm">${a.correo?.maÃ±ana ? getNombrePersona(a.correo.maÃ±ana) : '-'}</td>
                      <td class="p-3 text-sm">${a.correo?.tarde ? getNombrePersona(a.correo.tarde) : '-'}</td>
                      <td class="p-3 text-sm">${a.holdeo ? getNombrePersona(a.holdeo) : '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>

          <div class="bg-white rounded-lg shadow-md p-6">
            <h3 class="text-xl font-bold mb-4">ğŸ‰ Feriados de ${getNombreMes()}</h3>
            ${feriadosData.length > 0 ? `
              <div class="space-y-4">
                ${feriadosData.map(f => `
                  <div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 rounded">
                    <div class="font-bold text-lg mb-2">
                      ${f.dia} ${getNombreDia(f.dia)} - ${f.nombre}
                    </div>
                    <div class="text-sm text-gray-700">
                      <strong>Trabajaron (${f.trabajadores.length}):</strong>
                      ${f.trabajadores.length > 0 ? 
                        f.trabajadores.map(t => t.nombre).join(', ') :
                        'Nadie trabajÃ³ este feriado'
                      }
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : '<p class="text-gray-500">No hay feriados en este mes</p>'}
          </div>
        </div>
      `;
    }

    function renderCelda(personaId, dia) {
      const fechaKey = getFechaKey(dia);
      const licencia = licencias[personaId]?.[fechaKey];
      const trabaja = trabajaDia(personaId, dia);
      const esSab = esSabado(dia);
      const esDom = esDomingo(dia);
      const tipo = getTipoTrabajo(personaId);

      let bgColor = 'bg-gray-200';
      let texto = '';

      if (licencia) {
        bgColor = licencia === 'vacaciones' ? 'bg-purple-500 text-white' :
                  licencia === 'enfermedad' ? 'bg-red-500 text-white' : 'bg-blue-500 text-white';
        texto = licencia === 'vacaciones' ? 'ğŸ–ï¸' :
                licencia === 'enfermedad' ? 'ğŸ¥' : 'ğŸ“š';
      } else if (tipo === '6x3') {
        // Para 6x3, sÃ¡bados y domingos son dÃ­as normales segÃºn su rotaciÃ³n
        if (trabaja) {
          if (esSab || esDom) {
            bgColor = 'bg-yellow-400 text-white font-bold';
            texto = esSab ? 'SÃ¡b' : 'Dom';
          } else {
            bgColor = 'bg-green-100 border-2 border-green-400';
            texto = 'âœ“';
          }
        } else {
          // EstÃ¡ de franco
          bgColor = 'bg-orange-400 text-white';
          texto = 'F';
        }
      } else {
        // Para 5x1 y CÃ³rdoba
        if (esDom) {
          bgColor = 'bg-gray-300';
          texto = 'Dom';
        } else if (esSab && trabaja) {
          bgColor = 'bg-yellow-400 text-white font-bold';
          texto = 'SÃ¡b';
        } else if (esSab && !trabaja) {
          bgColor = 'bg-green-200';
          texto = '';
        } else if (trabaja) {
          bgColor = 'bg-green-100 border-2 border-green-400';
          texto = 'âœ“';
        } else {
          bgColor = 'bg-orange-400 text-white';
          texto = 'F';
        }
      }

      const deleteBtn = licencia ? `
        <button onclick="eliminarLicencia('${personaId}', '${fechaKey}')" 
                class="absolute top-0 right-0 bg-red-600 text-white text-xs px-1 rounded-bl opacity-0 group-hover:opacity-100">
          Ã—
        </button>
      ` : '';

      return `
        <td class="p-2 text-center relative group">
          <div class="${bgColor} rounded p-2 text-sm font-semibold relative">
            ${texto}
            ${deleteBtn}
          </div>
        </td>
      `;
    }

    function renderGrilla(titulo, equipo) {
      const diasMes = getDiasEnMes();
      const feriados = FERIADOS[mesSeleccionado] || [];

      return `
        <div class="max-w-7xl mx-auto p-6">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-3xl font-bold">${titulo}</h2>
            <select onchange="cambiarMes(this.value)" class="px-4 py-2 border-2 border-gray-300 rounded-lg font-semibold bg-white">
              ${MESES_DISPONIBLES.map(m => `<option value="${m.key}" ${m.key === mesSeleccionado ? 'selected' : ''}>${m.nombre}</option>`).join('')}
            </select>
          </div>
          
          <div class="bg-white rounded-lg shadow-md overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-gray-700 text-white">
                  <th class="p-3 text-left sticky left-0 bg-gray-700">DÃ­a</th>
                  ${equipo.map(p => `<th class="p-3 text-center">${p.nombre}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${Array.from({length: diasMes}, (_, i) => i + 1).map(dia => {
                  const nombreDia = getNombreDia(dia);
                  const esFer = feriados.includes(dia);
                  const esFin = nombreDia === 'SÃ¡b' || nombreDia === 'Dom';
                  const nombreFer = esFer ? getNombreFeriado(dia) : '';
                  
                  return `
                    <tr class="border-b ${esFin ? 'bg-blue-50' : ''} ${esFer ? 'bg-yellow-100' : ''}">
                      <td class="p-3 font-bold sticky left-0 ${esFin ? 'bg-blue-50' : esFer ? 'bg-yellow-100' : 'bg-white'}">
                        <div class="flex flex-col">
                          <span>${dia} ${nombreDia}</span>
                          ${esFer ? `<span class="text-xs text-yellow-700">ğŸ‰ ${nombreFer}</span>` : ''}
                        </div>
                      </td>
                      ${equipo.map(p => renderCelda(p.id, dia)).join('')}
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>

          <div class="mt-4 bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
            <p class="text-sm text-blue-800">
              <strong>Leyenda:</strong> 
              âœ“ Trabaja | F Franco | ğŸ–ï¸ Vacaciones | ğŸ¥ Enfermedad | ğŸ“š Examen | 
              Hover sobre licencias para eliminar
            </p>
          </div>
        </div>
      `;
    }

    function renderApp() {
      const app = document.getElementById('app');
      
      // Mostrar loading mientras carga Firebase
      if (cargando) {
        app.innerHTML = `
          <div class="flex items-center justify-center h-screen">
            <div class="text-center">
              <div class="animate-spin rounded-full h-32 w-32 border-b-2 border-blue-600 mx-auto"></div>
              <p class="mt-4 text-xl font-semibold text-gray-700">Cargando datos de Firebase...</p>
            </div>
          </div>
        `;
        return;
      }
      
      const header = `
        <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg">
          <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between mb-3">
              <h1 class="text-2xl font-bold">Sistema de GestiÃ³n de Turnos</h1>
              ${mensaje ? `<div class="bg-white text-blue-800 px-4 py-2 rounded-full font-semibold">${mensaje}</div>` : ''}
            </div>
            <nav class="flex gap-2 pb-2 overflow-x-auto">
              <button onclick="cambiarVista('dashboard')" class="px-4 py-2 rounded-t-lg font-semibold ${vistaActual === 'dashboard' ? 'bg-white text-blue-600' : 'bg-blue-700 hover:bg-blue-600'}">
                ğŸ  Dashboard
              </button>
              <button onclick="cambiarVista('caba6x3')" class="px-4 py-2 rounded-t-lg font-semibold ${vistaActual === 'caba6x3' ? 'bg-white text-blue-600' : 'bg-blue-700 hover:bg-blue-600'}">
                CABA 6x3
              </button>
              <button onclick="cambiarVista('caba5x1')" class="px-4 py-2 rounded-t-lg font-semibold ${vistaActual === 'caba5x1' ? 'bg-white text-blue-600' : 'bg-blue-700 hover:bg-blue-600'}">
                CABA SÃ¡bados
              </button>
              <button onclick="cambiarVista('cordoba')" class="px-4 py-2 rounded-t-lg font-semibold ${vistaActual === 'cordoba' ? 'bg-white text-blue-600' : 'bg-blue-700 hover:bg-blue-600'}">
                CÃ³rdoba
              </button>
            </nav>
          </div>
        </div>
      `;

      let contenido = '';
      if (vistaActual === 'dashboard') contenido = renderDashboard();
      else if (vistaActual === 'caba6x3') contenido = renderGrilla('CABA - RotaciÃ³n 6x3', EQUIPOS.caba_6x3);
      else if (vistaActual === 'caba5x1') contenido = renderGrilla('CABA - SÃ¡bados (5+1)', EQUIPOS.caba_5x1);
      else if (vistaActual === 'cordoba') contenido = renderGrilla('CÃ³rdoba - SÃ¡bados', EQUIPOS.cordoba);

      app.innerHTML = header + contenido + renderFormLicencia() + renderFormTareas();
    }

    renderApp();
  </script>
</body>
</html>
